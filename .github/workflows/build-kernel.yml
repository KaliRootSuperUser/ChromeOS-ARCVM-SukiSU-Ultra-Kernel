name: Build ChromeOS_ARCVM_SukiSU_Ultra_x86_64

on:
  workflow_dispatch:
    inputs:
      KERNEL_BRANCH:
        type: choice
        description: "ChromeOS Kernel Branch"
        required: true
        default: chromeos-5.10-arcvm
        options:
          - chromeos-5.10-arcvm
          - chromeos-5.15-arcvm
          - chromeos-6.1-arcvm
          - chromeos-6.6-arcvm
      ANDROID_VERSION:
        type: choice
        description: "Target Android Version"
        required: true
        default: android13
        options:
          - android12
          - android13
          - android14
          - android15
      KERNEL_VERSION:
        type: choice
        description: "Kernel Version"
        required: true
        default: "5.10"
        options:
          - "5.10"
          - "5.15"
          - "6.1"
          - "6.6"
      SUSFS_CI:
        type: boolean
        description: "Use CI build when downloading SUSFS module?"
        required: true
        default: true
      VFS:
        type: boolean
        description: "Enable manual hooks?"
        required: true
        default: true
      KPM:
        type: boolean
        description: "Enable KPM?"
        required: true
        default: true
      ZRAM:
        type: boolean
        description: "Enable adding more ZRAM algorithms?"
        required: true
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Configure Git
        run: |
          git config --global user.name "ChromeOS-Builder"
          git config --global user.email "builder@chromeos-arcvm.local"
          git config --global advice.detachedHead false

      - name: Install dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y \
            python3 python3-pip git curl wget bc bison flex \
            libssl-dev libelf-dev libncurses-dev libncurses5-dev \
            build-essential kmod cpio debhelper rsync dwarves \
            ccache zip unzip jq pv pigz

      - name: Setup ccache
        run: |
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          ccache --max-size=5G
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache -z

      - name: Show selected inputs debug
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "          BUILD CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Kernel Branch    : ${{ github.event.inputs.KERNEL_BRANCH }}"
          echo "Android Version  : ${{ github.event.inputs.ANDROID_VERSION }}"
          echo "Kernel Version   : ${{ github.event.inputs.KERNEL_VERSION }}"
          echo "SUSFS CI Build   : ${{ github.event.inputs.SUSFS_CI }}"
          echo "VFS Hooks        : ${{ github.event.inputs.VFS }}"
          echo "KPM Support      : ${{ github.event.inputs.KPM }}"
          echo "ZRAM Enhanced    : ${{ github.event.inputs.ZRAM }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Clone ChromeOS ARCVM Kernel
        run: |
          echo "ðŸ”½ Cloning ChromeOS ARCVM kernel source..."
          git clone https://chromium.googlesource.com/chromiumos/third_party/kernel.git \
            -b ${{ github.event.inputs.KERNEL_BRANCH }} --depth=1 kernel_source
          
          if [ ! -d "kernel_source" ]; then
            echo "âŒ Kernel source clone failed!"
            exit 1
          fi
          
          cd kernel_source
          echo "âœ… Kernel source cloned successfully"
          echo "ðŸ“Š Repository size: $(du -sh . | cut -f1)"

      - name: Add SukiSU Ultra to ChromeOS Kernel
        run: |
          cd kernel_source
          echo "ðŸ”§ Adding SukiSU Ultra (KernelSU) to kernel..."
          
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
          
          if [ ! -d "KernelSU" ]; then
            echo "âŒ KernelSU setup failed!"
            exit 1
          fi
          
          cd ./KernelSU
          KSU_VERSION=$(expr $(/usr/bin/git rev-list --count main) "+" 10606)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          export KSU_VERSION=$KSU_VERSION
          sed -i "s/DKSU_VERSION=12800/DKSU_VERSION=${KSU_VERSION}/" kernel/Makefile
          
          echo "âœ… SukiSU Ultra added with version: $KSU_VERSION"

      - name: Clone SUSFS and Patch Files
        run: |
          cd kernel_source
          echo "ðŸ“¥ Cloning SUSFS and patch repositories..."
          
          git clone https://gitlab.com/simonpunk/susfs4ksu.git \
            -b gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }} \
            --depth=1
          
          git clone https://github.com/ShirkNeko/SukiSU_patch.git --depth=1
          
          if [ ! -d "susfs4ksu" ] || [ ! -d "SukiSU_patch" ]; then
            echo "âŒ Patch repositories clone failed!"
            exit 1
          fi
          
          echo "âœ… SUSFS and patch repositories cloned"

      - name: Apply SUSFS Patches to ChromeOS Kernel
        run: |
          cd kernel_source
          echo "ðŸ”¨ Applying SUSFS patches to ChromeOS kernel..."
          
          # Verify patch file exists
          PATCH_FILE="susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch"
          if [ ! -f "$PATCH_FILE" ]; then
            echo "âŒ SUSFS patch file not found: $PATCH_FILE"
            exit 1
          fi
          
          # Copy SUSFS patches
          cp "$PATCH_FILE" ./
          cp -r susfs4ksu/kernel_patches/fs/* ./fs/ 2>/dev/null || true
          cp -r susfs4ksu/kernel_patches/include/linux/* ./include/linux/ 2>/dev/null || true

          # Apply ZRAM patches if enabled
          if [ "${{ github.event.inputs.ZRAM }}" = "true" ]; then
            echo "ðŸ”§ Applying ZRAM patches..."
            cp -r SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/ 2>/dev/null || true
            cp -r SukiSU_patch/other/zram/lz4k/lib/* ./lib/ 2>/dev/null || true
            cp -r SukiSU_patch/other/zram/lz4k/crypto/* ./crypto/ 2>/dev/null || true
            cp -r SukiSU_patch/other/zram/lz4k_oplus ./lib/ 2>/dev/null || true
          fi

          # Apply main SUSFS patch
          patch -p1 < "50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch" || true
          
          echo "âœ… SUSFS patches applied successfully"

      - name: Apply Hide Stuff Patches
        run: |
          cd kernel_source
          echo "ðŸ”’ Applying hide app patches..."
          
          if [ -f "SukiSU_patch/69_hide_stuff.patch" ]; then
            cp SukiSU_patch/69_hide_stuff.patch ./
            patch -p1 -F 3 < 69_hide_stuff.patch || true
            echo "âœ… Hide stuff patches applied"
          else
            echo "âš ï¸  Hide stuff patch not found, skipping..."
          fi

      - name: Apply VFS Hooks
        run: |
          cd kernel_source
          if [ "${{ github.event.inputs.VFS }}" = "true" ]; then
            echo "ðŸ”— Applying VFS manual hooks patches..."
            
            if [ -f "SukiSU_patch/hooks/syscall_hooks.patch" ]; then
              cp SukiSU_patch/hooks/syscall_hooks.patch ./
              patch -p1 -F 3 < syscall_hooks.patch || true
              echo "âœ… VFS hooks applied successfully"
            else
              echo "âš ï¸  VFS hooks patch not found, skipping..."
            fi
          else
            echo "â­ï¸  VFS hooks disabled, skipping..."
          fi

      - name: Apply LZ4KD Patches
        run: |
          cd kernel_source
          if [ "${{ github.event.inputs.ZRAM }}" = "true" ]; then
            echo "ðŸ“¦ Applying LZ4KD patches..."
            
            ZRAM_PATCH="SukiSU_patch/other/zram/zram_patch/${{ github.event.inputs.KERNEL_VERSION }}/lz4kd.patch"
            if [ -f "$ZRAM_PATCH" ]; then
              cp "$ZRAM_PATCH" ./
              patch -p1 -F 3 < lz4kd.patch || true
              echo "âœ… LZ4KD patches applied successfully"
            else
              echo "âš ï¸  LZ4KD patch not found for kernel version ${{ github.event.inputs.KERNEL_VERSION }}"
            fi
          else
            echo "â­ï¸  ZRAM enhancement disabled, skipping..."
          fi

      - name: Configure ChromeOS Kernel for x86_64
        run: |
          cd kernel_source
          echo "âš™ï¸  Configuring ChromeOS kernel for x86_64..."
          
          # Find the appropriate defconfig for ChromeOS ARCVM x86_64
          if [ -f arch/x86/configs/chromiumos-x86_64_defconfig ]; then
            CONFIG_FILE=arch/x86/configs/chromiumos-x86_64_defconfig
          elif [ -f arch/x86/configs/chromeos_defconfig ]; then
            CONFIG_FILE=arch/x86/configs/chromeos_defconfig
          else
            CONFIG_FILE=arch/x86/configs/x86_64_defconfig
          fi

          echo "ðŸ“ Using config file: $CONFIG_FILE"

          # SukiSU Ultra configuration
          echo "CONFIG_KSU=y" >> "$CONFIG_FILE"
          echo "CONFIG_KPM=y" >> "$CONFIG_FILE"
          
          if [ "${{ github.event.inputs.VFS }}" = "false" ]; then
            echo "CONFIG_KPROBES=y" >> "$CONFIG_FILE"
          fi

          # VFS configuration
          if [ "${{ github.event.inputs.VFS }}" = "true" ]; then
            echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_MANUAL_HOOK=y" >> "$CONFIG_FILE"
          else
            echo "CONFIG_KSU_SUSFS_SUS_SU=y" >> "$CONFIG_FILE"
          fi

          # SUSFS configuration
          if [ "${{ github.event.inputs.VFS }}" = "true" ]; then
            echo "CONFIG_KSU_SUSFS=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$CONFIG_FILE"
          fi

          # ZRAM/LZ4KD configuration
          if [ "${{ github.event.inputs.ZRAM }}" = "true" ]; then
            echo "CONFIG_ZSMALLOC=y" >> "$CONFIG_FILE"
            echo "CONFIG_ZRAM=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_LZO=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_LZ4=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_LZ4HC=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_LZ4K=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_LZ4KD=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_842=y" >> "$CONFIG_FILE"
            echo "CONFIG_ZRAM_WRITEBACK=y" >> "$CONFIG_FILE"
            
            if [ "${{ github.event.inputs.KERNEL_VERSION }}" = "5.10" ]; then
              echo "CONFIG_ZRAM_DEF_COMP_LZ4KD=y" >> "$CONFIG_FILE"
            fi
          fi

          # x86_64 specific settings
          echo "CONFIG_64BIT=y" >> "$CONFIG_FILE"
          echo "CONFIG_X86_64=y" >> "$CONFIG_FILE"
          
          echo "âœ… Kernel configuration completed"

      - name: Build ChromeOS ARCVM x86_64 Kernel
        run: |
          cd kernel_source
          echo "ðŸ”¨ Building ChromeOS ARCVM x86_64 kernel..."
          
          # Determine config file
          if [ -f arch/x86/configs/chromiumos-x86_64_defconfig ]; then
            DEFCONFIG=chromiumos-x86_64_defconfig
          elif [ -f arch/x86/configs/chromeos_defconfig ]; then
            DEFCONFIG=chromeos_defconfig
          else
            DEFCONFIG=x86_64_defconfig
          fi

          echo "ðŸ“‹ Building with defconfig: $DEFCONFIG"
          
          # Record start time
          BUILD_START=$(date +%s)
          
          # Generate .config
          make ARCH=x86_64 $DEFCONFIG
          
          # Build kernel with progress indication
          echo "âš¡ Starting parallel build with $(nproc) cores..."
          make ARCH=x86_64 -j$(nproc) bzImage modules 2>&1 | tee build.log
          
          # Calculate build time
          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          
          # Verify build success
          if [ -f arch/x86/boot/bzImage ] || [ -f arch/x86_64/boot/bzImage ]; then
            echo "âœ… Kernel build completed in ${BUILD_TIME}s ($(($BUILD_TIME / 60))m)"
          else
            echo "âŒ Kernel build failed - bzImage not found!"
            exit 1
          fi

      - name: Show ccache statistics
        run: |
          echo "ðŸ“Š ccache statistics:"
          ccache -s

      - name: Apply KPM Patch to bzImage
        if: ${{ github.event.inputs.KPM == 'true' }}
        run: |
          cd kernel_source
          echo "ðŸ”§ Applying KPM patch to bzImage..."
          
          # Find bzImage location
          if [ -f arch/x86/boot/bzImage ]; then
            BZIMAGE_PATH=arch/x86/boot/bzImage
          elif [ -f arch/x86_64/boot/bzImage ]; then
            BZIMAGE_PATH=arch/x86_64/boot/bzImage
          else
            echo "âŒ bzImage not found!"
            exit 1
          fi

          echo "ðŸ“ Found bzImage at: $BZIMAGE_PATH"
          
          # Download and apply patch_linux
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o patch_linux
          chmod +x patch_linux
          
          # Backup original
          cp $BZIMAGE_PATH bzImage.orig
          
          # Copy bzImage to current directory for patching
          cp $BZIMAGE_PATH ./bzImage
          
          # Apply KPM patch
          if ./patch_linux; then
            # Replace original with patched version
            rm -f bzImage
            mv oBzImage bzImage
            cp bzImage $BZIMAGE_PATH
            echo "âœ… KPM patch applied successfully to bzImage"
          else
            echo "âš ï¸  KPM patch failed, using original bzImage"
            cp bzImage.orig $BZIMAGE_PATH
          fi

      - name: Create ChromeOS ARCVM Kernel Package
        run: |
          mkdir -p chromeos_kernel_output
          cd kernel_source
          echo "ðŸ“¦ Creating ChromeOS ARCVM kernel package..."
          
          # Find and copy bzImage
          if [ -f arch/x86/boot/bzImage ]; then
            cp arch/x86/boot/bzImage ../chromeos_kernel_output/
            echo "âœ… Copied bzImage from arch/x86/boot/"
          elif [ -f arch/x86_64/boot/bzImage ]; then
            cp arch/x86_64/boot/bzImage ../chromeos_kernel_output/
            echo "âœ… Copied bzImage from arch/x86_64/boot/"
          else
            echo "âŒ bzImage not found!"
            exit 1
          fi
          
          # Copy modules
          echo "ðŸ“¦ Installing kernel modules..."
          make ARCH=x86_64 INSTALL_MOD_PATH=../chromeos_kernel_output modules_install
          
          # Create info file
          cd ../chromeos_kernel_output
          cat > KERNEL_INFO.txt << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      ChromeOS ARCVM x86_64 SukiSU Ultra Kernel            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“‹ Build Information:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Kernel Branch       : ${{ github.event.inputs.KERNEL_BRANCH }}
Android Version     : ${{ github.event.inputs.ANDROID_VERSION }}
Kernel Version      : ${{ github.event.inputs.KERNEL_VERSION }}
SukiSU Ultra Version: ${{ env.KSUVER }}
Build Date          : $(date)
Build Time          : ${{ env.BUILD_TIME }}s

âœ¨ Features:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
VFS Manual Hooks    : ${{ github.event.inputs.VFS }}
KPM Enabled         : ${{ github.event.inputs.KPM }}
ZRAM Enhanced       : ${{ github.event.inputs.ZRAM }}

ðŸ“¦ Package Contents:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ bzImage (ChromeOS ARCVM kernel)
â€¢ Kernel modules
â€¢ SUSFS module
â€¢ Installation scripts
â€¢ Documentation

ðŸš€ Installation Instructions:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Extract bzImage from this package
2. Replace your ChromeOS ARCVM kernel image
3. Reboot your Chromebook
4. Install KernelSU Manager app in Android container
5. Install SUSFS module from the package

âš ï¸  Requirements:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ ChromeOS with Developer Mode enabled
â€¢ ARCVM (Android container) enabled
â€¢ x86_64 CPU architecture
â€¢ Backup of original kernel recommended

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
For support: https://github.com/SukiSU-Ultra/SukiSU-Ultra
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
          
          echo "âœ… Kernel package prepared"

      - name: Download SUSFS Module from CI
        if: ${{ github.event.inputs.SUSFS_CI == 'true' }}
        run: |
          echo "ðŸ“¥ Downloading SUSFS module from CI..."
          
          LATEST_RUN_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs?status=success" | \
            jq -r '.workflow_runs[] | select(.head_branch == "v1.5.2+") | .id' | head -n 1)

          if [ -z "$LATEST_RUN_ID" ]; then
            echo "âš ï¸  No successful CI run found for branch v1.5.2+, falling back to release..."
            wget -q https://github.com/sidex15/ksu_module_susfs/releases/latest/download/ksu_module_susfs_1.5.2+.zip \
              -O ksu_module_susfs.zip
          else
            ARTIFACT_URL=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs/$LATEST_RUN_ID/artifacts" | \
              jq -r '.artifacts[0].archive_download_url')
            
            curl -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -o ksu_module_susfs.zip "$ARTIFACT_URL"
          fi
          
          cp ksu_module_susfs.zip ./chromeos_kernel_output/
          echo "âœ… SUSFS module downloaded"

      - name: Download SUSFS Module from Release
        if: ${{ github.event.inputs.SUSFS_CI == 'false' }}
        run: |
          echo "ðŸ“¥ Downloading SUSFS module from release..."
          wget -q https://github.com/sidex15/ksu_module_susfs/releases/latest/download/ksu_module_susfs_1.5.2+.zip \
            -O ksu_module_susfs.zip
          cp ksu_module_susfs.zip ./chromeos_kernel_output/
          echo "âœ… SUSFS module downloaded"

      - name: Create Installation Script
        run: |
          cd chromeos_kernel_output
          cat > install_chromeos.sh << 'INSTALLEOF'
#!/bin/bash
# ChromeOS ARCVM SukiSU Ultra Kernel Installation Script

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        ChromeOS ARCVM SukiSU Ultra Installer              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âš ï¸  WARNING: This will modify your ChromeOS kernel!"
echo "    Make sure you have a backup before proceeding."
echo ""
read -p "Continue? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "Installation cancelled."
    exit 1
fi

# Enable developer mode check
if [ ! -f /usr/share/vboot/bin/make_dev_ssd.sh ]; then
    echo "âŒ Error: ChromeOS developer mode not enabled!"
    echo "   Please enable developer mode first."
    exit 1
fi

# Remove rootfs verification
echo "ðŸ”“ Removing rootfs verification..."
sudo /usr/share/vboot/bin/make_dev_ssd.sh --remove_rootfs_verification --partitions 4

# Mount root as read-write
echo "ðŸ’¾ Remounting root as read-write..."
sudo mount -o remount,rw /

# Backup original kernel
echo "ðŸ“¦ Backing up original kernel..."
KERNEL_PATH="/opt/google/containers/android/system.raw.img"
if [ -f "$KERNEL_PATH" ]; then
    sudo cp "$KERNEL_PATH" "${KERNEL_PATH}.backup"
    echo "âœ… Original kernel backed up to ${KERNEL_PATH}.backup"
fi

# Install new kernel
echo "ðŸ”§ Installing SukiSU Ultra kernel..."
sudo cp bzImage "$KERNEL_PATH"

# Install modules
echo "ðŸ“¦ Installing kernel modules..."
sudo cp -r lib/modules/* /lib/modules/

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          Installation completed successfully!             â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“‹ Next steps:"
echo "  1. Reboot your Chromebook"
echo "  2. Install KernelSU Manager in Android"
echo "  3. Flash the SUSFS module from this package"
echo ""
read -p "Reboot now? (yes/no): " reboot_confirm

if [ "$reboot_confirm" = "yes" ]; then
    sudo reboot
fi
INSTALLEOF
          chmod +x install_chromeos.sh
          echo "âœ… Installation script created"

      - name: Create README
        run: |
          cd chromeos_kernel_output
          cat > README.md << 'READMEEOF'
# ChromeOS ARCVM x86_64 SukiSU Ultra Kernel

This package contains a custom ChromeOS ARCVM kernel with integrated SukiSU Ultra (KernelSU) and SUSFS support.

## âœ¨ Features

- âœ… SukiSU Ultra (KernelSU) integrated
- âœ… SUSFS (Hiding root detection)
- âœ… KPM (Kernel Patch Module) support
- âœ… VFS manual hooks
- âœ… Enhanced ZRAM with LZ4KD compression
- âœ… x86_64 architecture optimized for ChromeOS ARCVM

## ðŸ“‹ Requirements

- ChromeOS device with developer mode enabled
- ARCVM (Android container) enabled
- x86_64 CPU architecture
- Basic knowledge of ChromeOS internals

## ðŸš€ Installation

### Step 1: Enable Developer Mode

1. Power off your Chromebook
2. Press `ESC + Refresh + Power` to enter Recovery Mode
3. Press `Ctrl + D` to enable Developer Mode
4. Follow on-screen instructions

### Step 2: Install the Kernel

```bash
# Extract the package
unzip CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA-SUSFS-KERNEL.zip
cd chromeos_kernel_output

# Run installation script
./install_chromeos.sh
```

### Step 3: Install KernelSU Manager

1. Reboot your Chromebook
2. Open Android container
3. Install KernelSU Manager APK
4. Verify root access

### Step 4: Install SUSFS Module

1. In KernelSU Manager, go to Modules
2. Click "Install from storage"
3. Select the included `ksu_module_susfs*.zip`
4. Reboot

## ðŸ”§ Manual Installation

If the automatic script doesn't work:

```bash
# Remove rootfs verification
sudo /usr/share/vboot/bin/make_dev_ssd.sh --remove_rootfs_verification --partitions 4

# Remount as read-write
sudo mount -o remount,rw /

# Backup original kernel
sudo cp /opt/google/containers/android/system.raw.img /opt/google/containers/android/system.raw.img.backup

# Copy new kernel
sudo cp bzImage /opt/google/containers/android/system.raw.img

# Install modules
sudo cp -r lib/modules/* /lib/modules/

# Reboot
sudo reboot
```

## âœ… Verification

After installation and reboot:

1. Open Android container
2. Install and open KernelSU Manager
3. Check if root access is granted
4. Verify kernel version shows SukiSU Ultra

## ðŸ”§ Troubleshooting

### Chromebook won't boot
- Reboot into Recovery Mode
- Restore from backup or reinstall ChromeOS

### ARCVM won't start
- Check if Android container is enabled in settings
- Verify kernel image wasn't corrupted during copy

### Root not working
- Ensure KernelSU Manager is latest version
- Check if SUSFS module is installed correctly
- Verify kernel version in KernelSU Manager

## ðŸ”„ Reverting to Original Kernel

```bash
sudo mount -o remount,rw /
sudo cp /opt/google/containers/android/system.raw.img.backup /opt/google/containers/android/system.raw.img
sudo reboot
```

## âš ï¸ Important Notes

- âš ï¸ This voids your warranty
- âš ï¸ Developer mode reduces security
- âš ï¸ Keep backups of important data
- âš ï¸ Some apps may detect root despite SUSFS

## ðŸ†˜ Support

For issues and questions:
- GitHub Issues: [SukiSU Ultra Repository](https://github.com/SukiSU-Ultra/SukiSU-Ultra)
- XDA Forums: ChromeOS Development Section

## ðŸ™ Credits

- SukiSU Ultra Team
- SUSFS Project
- KernelSU Project
- ChromeOS Kernel Team

## ðŸ“œ License

This kernel includes components under various open source licenses.
See individual component licenses for details.
READMEEOF
          echo "âœ… README created"

      - name: Set suffix for package name
        id: suffix
        run: |
          SUFFIX=""
          if [ "${{ github.event.inputs.KPM }}" = "true" ]; then
            SUFFIX="${SUFFIX}_KPM"
          fi
          if [ "${{ github.event.inputs.VFS }}" = "true" ]; then
            SUFFIX="${SUFFIX}_VFS"
          fi
          if [ "${{ github.event.inputs.ZRAM }}" = "true" ]; then
            SUFFIX="${SUFFIX}_LZ4KD"
          fi
          echo "value=$SUFFIX" >> $GITHUB_OUTPUT
          echo "ðŸ“ Package suffix: $SUFFIX"

      - name: Package ChromeOS Kernel
        run: |
          cd chromeos_kernel_output
          echo "ðŸ—œï¸  Creating ZIP package..."
          zip -r ../CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA-SUSFS-KERNEL${{ steps.suffix.outputs.value }}.zip . -q
          cd ..
          
          PACKAGE_SIZE=$(du -h "CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA-SUSFS-KERNEL${{ steps.suffix.outputs.value }}.zip" | cut -f1)
          echo "âœ… Package created: CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA-SUSFS-KERNEL${{ steps.suffix.outputs.value }}.zip"
          echo "ðŸ“¦ Package size: $PACKAGE_SIZE"

      - name: Upload ChromeOS ARCVM Kernel Package
        uses: actions/upload-artifact@v4
        with:
          name: CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA_${{ env.KSUVER }}${{ steps.suffix.outputs.value }}
          path: CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA-SUSFS-KERNEL${{ steps.suffix.outputs.value }}.zip
          retention-days: 90
          compression-level: 0

      - name: Upload bzImage separately
        uses: actions/upload-artifact@v4
        with:
          name: bzImage-ChromeOS-ARCVM-x86_64_${{ env.KSUVER }}${{ steps.suffix.outputs.value }}
          path: chromeos_kernel_output/bzImage
          retention-days: 90

      - name: Prepare Modified Kernel Source Tree
        run: |
          echo "ðŸ“¦ Preparing modified kernel source tree for distribution..."
          cd kernel_source
          
          # Remove build artifacts to reduce size
          echo "ðŸ§¹ Cleaning build artifacts..."
          make clean || true
          make mrproper || true
          
          # Remove unnecessary files
          echo "ðŸ—‘ï¸  Removing unnecessary files..."
          rm -rf .git 2>/dev/null || true
          rm -rf susfs4ksu/.git 2>/dev/null || true
          rm -rf SukiSU_patch/.git 2>/dev/null || true
          rm -rf KernelSU/.git 2>/dev/null || true
          
          # Remove patch files (already applied)
          rm -f *.patch 2>/dev/null || true
          
          # Remove build logs
          rm -f build.log 2>/dev/null || true
          
          # Create source tree info
          cat > SOURCE_TREE_INFO.txt << 'SOURCEEOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ChromeOS ARCVM x86_64 SukiSU Ultra + SUSFS Kernel       â•‘
â•‘            Modified Source Tree Package                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“‹ Package Information:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
SOURCEEOF
          
          cat >> SOURCE_TREE_INFO.txt << EOF
Original Kernel Branch : ${{ github.event.inputs.KERNEL_BRANCH }}
Android Target Version : ${{ github.event.inputs.ANDROID_VERSION }}
Kernel Version        : ${{ github.event.inputs.KERNEL_VERSION }}
SukiSU Ultra Version  : ${{ env.KSUVER }}
Build Date            : $(date)

ðŸ”§ Applied Modifications:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… SukiSU Ultra (KernelSU) - Integrated
âœ… SUSFS Framework        - Fully Patched
âœ… VFS Manual Hooks       - ${{ github.event.inputs.VFS }}
âœ… KPM Support            - ${{ github.event.inputs.KPM }}
âœ… ZRAM LZ4KD             - ${{ github.event.inputs.ZRAM }}
âœ… Hide Stuff Patches     - Applied
âœ… Root Detection Bypass  - Configured

ðŸ“‚ Source Tree Contents:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â€¢ Complete kernel source code with all patches applied
â€¢ KernelSU integration files
â€¢ SUSFS framework implementation
â€¢ Modified kernel configurations
â€¢ Build scripts and documentation

ðŸš€ Building This Source:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Extract this archive:
   tar -xzf ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE.tar.gz

2. Navigate to source directory:
   cd kernel_source

3. Configure kernel (config already modified):
   make ARCH=x86_64 chromiumos-x86_64_defconfig
   # OR if using custom config:
   make ARCH=x86_64 x86_64_defconfig

4. Build kernel:
   make ARCH=x86_64 -j\$(nproc) bzImage modules

5. Install modules (optional):
   make ARCH=x86_64 INSTALL_MOD_PATH=/path/to/install modules_install

6. Find bzImage at:
   arch/x86/boot/bzImage

ðŸ“– Additional Documentation:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â€¢ KernelSU: ./KernelSU/README.md
â€¢ SUSFS: ./susfs4ksu/README.md
â€¢ ChromeOS Kernel: ./Documentation/

âš ï¸  Important Notes:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â€¢ This source tree contains all modifications pre-applied
â€¢ No additional patching required
â€¢ Configuration files are pre-modified for SukiSU Ultra + SUSFS
â€¢ Build on Linux system with kernel build dependencies
â€¢ Recommended: Ubuntu 22.04+ with build-essential package

ðŸ”— Resources:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â€¢ SukiSU Ultra: https://github.com/SukiSU-Ultra/SukiSU-Ultra
â€¢ SUSFS Project: https://gitlab.com/simonpunk/susfs4ksu
â€¢ KernelSU: https://kernelsu.org

ðŸ“œ License:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

This modified kernel source maintains all original licenses:
â€¢ Linux Kernel: GPL-2.0
â€¢ KernelSU: GPL-3.0
â€¢ SUSFS: GPL-3.0
â€¢ ChromeOS modifications: BSD/GPL mixed

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Generated by ChromeOS ARCVM Kernel Rooting CI/CD Pipeline
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
          
          echo "âœ… Source tree info created"

      - name: Create Build Instructions Script
        run: |
          cd kernel_source
          cat > BUILD_INSTRUCTIONS.sh << 'BUILDEOF'
#!/bin/bash
# ChromeOS ARCVM x86_64 SukiSU Ultra + SUSFS Kernel Build Script
# This script automates the kernel building process

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ChromeOS ARCVM Kernel Build Script                      â•‘"
echo "â•‘   SukiSU Ultra + SUSFS Edition                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check dependencies
echo "ðŸ” Checking build dependencies..."
DEPS="gcc make bc bison flex libssl-dev libelf-dev"
MISSING=""

for dep in $DEPS; do
    if ! dpkg -l | grep -q "^ii  $dep"; then
        MISSING="$MISSING $dep"
    fi
done

if [ -n "$MISSING" ]; then
    echo "âŒ Missing dependencies:$MISSING"
    echo "ðŸ“¦ Install with: sudo apt install -y$MISSING"
    exit 1
fi

echo "âœ… All dependencies present"
echo ""

# Get CPU cores
CORES=$(nproc)
echo "ðŸ”§ Using $CORES CPU cores for compilation"
echo ""

# Configure kernel
echo "âš™ï¸  Configuring kernel..."
if [ -f arch/x86/configs/chromiumos-x86_64_defconfig ]; then
    make ARCH=x86_64 chromiumos-x86_64_defconfig
elif [ -f arch/x86/configs/chromeos_defconfig ]; then
    make ARCH=x86_64 chromeos_defconfig
else
    make ARCH=x86_64 x86_64_defconfig
fi
echo "âœ… Kernel configured"
echo ""

# Build kernel
echo "ðŸ”¨ Building kernel (this will take 20-40 minutes)..."
START_TIME=$(date +%s)

make ARCH=x86_64 -j$CORES bzImage modules

END_TIME=$(date +%s)
BUILD_TIME=$((END_TIME - START_TIME))

echo ""
echo "âœ… Kernel build completed in ${BUILD_TIME} seconds!"
echo ""

# Show results
if [ -f arch/x86/boot/bzImage ]; then
    BZIMAGE_PATH="arch/x86/boot/bzImage"
elif [ -f arch/x86_64/boot/bzImage ]; then
    BZIMAGE_PATH="arch/x86_64/boot/bzImage"
else
    echo "âŒ bzImage not found!"
    exit 1
fi

echo "ðŸ“¦ Build Results:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "bzImage location: $BZIMAGE_PATH"
echo "bzImage size: $(du -h $BZIMAGE_PATH | cut -f1)"
echo "Build time: ${BUILD_TIME}s ($(($BUILD_TIME / 60))m $(($BUILD_TIME % 60))s)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸŽ‰ Success! Your ChromeOS ARCVM kernel is ready!"
echo ""
echo "ðŸ“‹ Next steps:"
echo "1. Copy bzImage to your ChromeOS device"
echo "2. Follow installation instructions in README.md"
echo "3. Install KernelSU Manager in Android container"
BUILDEOF

          chmod +x BUILD_INSTRUCTIONS.sh
          echo "âœ… Build script created"

      - name: Calculate Source Tree Size
        id: source_size
        run: |
          cd kernel_source
          SIZE_BYTES=$(du -sb . | cut -f1)
          SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Source tree size: ${SIZE_MB} MB (uncompressed)"

      - name: Create Source Tree Archive
        run: |
          echo "ðŸ“¦ Creating source tree archive..."
          echo "â³ This may take 5-10 minutes depending on compression..."
          
          # Create archive with better compression and progress
          tar -I "pigz -9" -cf "ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz" \
              --exclude='*.o' \
              --exclude='*.ko' \
              --exclude='.tmp_*' \
              --exclude='*.cmd' \
              --exclude='.cache' \
              --exclude='*.a' \
              --exclude='*.so' \
              kernel_source/
          
          # Calculate final archive size
          ARCHIVE_SIZE=$(du -h "ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz" | cut -f1)
          echo "âœ… Archive created: ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz"
          echo "ðŸ“¦ Archive size: $ARCHIVE_SIZE (compressed)"
          echo "ARCHIVE_SIZE=$ARCHIVE_SIZE" >> $GITHUB_ENV

      - name: Verify Archive Integrity
        run: |
          echo "ðŸ” Verifying archive integrity..."
          
          # Test archive
          if tar -tzf "ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz" > /dev/null 2>&1; then
            echo "âœ… Archive integrity verified"
          else
            echo "âŒ Archive verification failed!"
            exit 1
          fi
          
          # Count files
          FILE_COUNT=$(tar -tzf "ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz" | wc -l)
          echo "ðŸ“„ Total files in archive: $FILE_COUNT"

      - name: Generate Source Tree Manifest
        run: |
          echo "ðŸ“‹ Generating source tree manifest..."
          
          cat > SOURCE_TREE_MANIFEST.txt << 'MANIFESTEOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      CHROMEOS ARCVM KERNEL SOURCE TREE MANIFEST           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MANIFESTEOF
          
          cat >> SOURCE_TREE_MANIFEST.txt << EOF

ðŸ“¦ Package Details:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Archive Name    : ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz
Archive Size    : ${{ env.ARCHIVE_SIZE }}
Source Size     : ${{ steps.source_size.outputs.size_mb }} MB (uncompressed)
Build Date      : $(date)
Git Commit      : ${{ github.sha }}
Workflow Run    : ${{ github.run_number }}

ðŸ”§ Build Configuration:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Kernel Branch   : ${{ github.event.inputs.KERNEL_BRANCH }}
Android Version : ${{ github.event.inputs.ANDROID_VERSION }}
Kernel Version  : ${{ github.event.inputs.KERNEL_VERSION }}
KSU Version     : ${{ env.KSUVER }}

âœ¨ Features Enabled:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
VFS Hooks       : ${{ github.event.inputs.VFS == 'true' && 'âœ… Enabled' || 'âŒ Disabled' }}
KPM Support     : ${{ github.event.inputs.KPM == 'true' && 'âœ… Enabled' || 'âŒ Disabled' }}
ZRAM Enhanced   : ${{ github.event.inputs.ZRAM == 'true' && 'âœ… Enabled' || 'âŒ Disabled' }}

ðŸ“‚ Contents:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Full ChromeOS ARCVM kernel source (modified)
âœ… KernelSU integration (SukiSU Ultra)
âœ… SUSFS framework patches (applied)
âœ… Build instructions script
âœ… Configuration files (pre-configured)
âœ… Documentation

ðŸ” Checksums:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
SHA256: $(sha256sum "ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz" | cut -d' ' -f1)
MD5:    $(md5sum "ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz" | cut -d' ' -f1)

ðŸ“– Quick Start:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
tar -xzf ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz
cd kernel_source
./BUILD_INSTRUCTIONS.sh

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
          
          echo "âœ… Manifest created"

      - name: Upload Modified Kernel Source Tree
        uses: actions/upload-artifact@v4
        with:
          name: ARCVM-x86_64-SUKISU-ULTRA-SUSFS-SOURCE_${{ env.KSUVER }}${{ steps.suffix.outputs.value }}
          path: |
            ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz
            SOURCE_TREE_MANIFEST.txt
          retention-days: 90
          compression-level: 0

      - name: Create Combined Release Package
        run: |
          echo "ðŸ“¦ Creating combined release package..."
          mkdir -p combined_release
          
          # Copy compiled kernel package
          cp CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA-SUSFS-KERNEL${{ steps.suffix.outputs.value }}.zip combined_release/
          
          # Copy source tree archive
          cp ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz combined_release/
          
          # Copy manifest
          cp SOURCE_TREE_MANIFEST.txt combined_release/
          
          # Create master README
          cat > combined_release/README_COMBINED_RELEASE.txt << 'COMBINEDEOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ChromeOS ARCVM SukiSU Ultra + SUSFS Complete Release  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This package contains BOTH:

ðŸ“¦ 1. COMPILED KERNEL PACKAGE (Ready to Install)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
COMBINEDEOF
          
          cat >> combined_release/README_COMBINED_RELEASE.txt << EOF
File: CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA-SUSFS-KERNEL${{ steps.suffix.outputs.value }}.zip
Size: ~50-80 MB
Contains:
  â€¢ bzImage (ready to install)
  â€¢ Kernel modules
  â€¢ SUSFS module
  â€¢ Installation scripts
  â€¢ Documentation

Use this if: You want to install immediately on ChromeOS

ðŸ“¦ 2. MODIFIED SOURCE TREE (For Custom Builds)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
File: ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz
Size: ${{ env.ARCHIVE_SIZE }}
Contains:
  â€¢ Complete kernel source (patches applied)
  â€¢ KernelSU integration
  â€¢ SUSFS framework
  â€¢ Build scripts
  â€¢ Pre-configured settings

Use this if: You want to customize or rebuild the kernel

ðŸš€ Quick Installation (Compiled Package):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Extract: CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA-SUSFS-KERNEL${{ steps.suffix.outputs.value }}.zip
2. Run: ./install_chromeos.sh
3. Reboot and enjoy root access!

ðŸ”¨ Building from Source:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Extract: ARCVM_x86_64_SUKISU-ULTRA+SUSFS_KERNEL_SOURCE${{ steps.suffix.outputs.value }}.tar.gz
2. cd kernel_source
3. ./BUILD_INSTRUCTIONS.sh
4. Find bzImage in arch/x86/boot/

ðŸ“‹ Build Information:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Build Date      : $(date)
KSU Version     : ${{ env.KSUVER }}
Kernel Branch   : ${{ github.event.inputs.KERNEL_BRANCH }}
Features        : VFS:${{ github.event.inputs.VFS }} KPM:${{ github.event.inputs.KPM }} ZRAM:${{ github.event.inputs.ZRAM }}

âš ï¸  Important:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Requires ChromeOS Developer Mode
â€¢ Voids warranty
â€¢ Backup your data before installation
â€¢ For x86_64 architecture only

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
For support and updates, visit the GitHub repository
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
          
          echo "âœ… Combined release package created"

      - name: Upload Complete Combined Package
        uses: actions/upload-artifact@v4
        with:
          name: COMPLETE-ARCVM-SUKISU-ULTRA-PACKAGE_${{ env.KSUVER }}${{ steps.suffix.outputs.value }}
          path: combined_release/*
          retention-days: 90

      - name: Generate Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARYEOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          BUILD COMPLETED SUCCESSFULLY âœ…                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ðŸ“¦ Available Downloads

### 1ï¸âƒ£ Compiled Kernel Package (Ready to Install)
SUMMARYEOF
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
- **Artifact:** `CHROMEBOOK-ARCVM-x86_64-SUKISU-ULTRA_${{ env.KSUVER }}${{ steps.suffix.outputs.value }}`
- **Size:** ~50-80 MB
- **Contains:** bzImage, modules, SUSFS, scripts

### 2ï¸âƒ£ Modified Source Tree (For Custom Builds)
- **Artifact:** `ARCVM-x86_64-SUKISU-ULTRA-SUSFS-SOURCE_${{ env.KSUVER }}${{ steps.suffix.outputs.value }}`
- **Size:** ${{ env.ARCHIVE_SIZE }}
- **Contains:** Complete kernel source with patches applied

### 3ï¸âƒ£ Complete Combined Package
- **Artifact:** `COMPLETE-ARCVM-SUKISU-ULTRA-PACKAGE_${{ env.KSUVER }}${{ steps.suffix.outputs.value }}`
- **Contains:** Both compiled kernel + source tree

## âœ¨ Build Configuration

| Setting | Value |
|---------|-------|
| Kernel Branch | `${{ github.event.inputs.KERNEL_BRANCH }}` |
| Android Version | `${{ github.event.inputs.ANDROID_VERSION }}` |
| KSU Version | `${{ env.KSUVER }}` |
| VFS Hooks | ${{ github.event.inputs.VFS == 'true' && 'âœ…' || 'âŒ' }} |
| KPM | ${{ github.event.inputs.KPM == 'true' && 'âœ…' || 'âŒ' }} |
| ZRAM | ${{ github.event.inputs.ZRAM == 'true' && 'âœ…' || 'âŒ' }} |
| Build Time | `${{ env.BUILD_TIME }}s` |

## ðŸŽ¯ Quick Download

```bash
# Download all artifacts
gh run download ${{ github.run_id }}

# Or download specific artifact:
gh run download ${{ github.run_id }} -n COMPLETE-ARCVM-SUKISU-ULTRA-PACKAGE_${{ env.KSUVER }}${{ steps.suffix.outputs.value }}
```

## ðŸ“Š Build Statistics

- **Source Tree Size:** ${{ steps.source_size.outputs.size_mb }} MB (uncompressed)
- **Compressed Archive:** ${{ env.ARCHIVE_SIZE }}
- **Total Artifacts:** 4
- **Workflow Run:** #${{ github.run_number }}

EOF
          
          echo "âœ… Build summary generated"

      - name: Final Success Message
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                            â•‘"
          echo "â•‘   âœ… ChromeOS ARCVM SukiSU Ultra Build Complete! âœ…       â•‘"
          echo "â•‘                                                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“¦ Available Artifacts:"
          echo "  1. Compiled Kernel Package"
          echo "  2. Standalone bzImage"
          echo "  3. Modified Source Tree"
          echo "  4. Complete Combined Package"
          echo ""
          echo "ðŸŽ‰ All artifacts ready for download!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
