name: Build ChromeOS ARCVM Kernel with SukiSU Ultra + SUSFS

on:
  workflow_dispatch:
    inputs:
      KERNEL_BRANCH:
        description: 'Select kernel branch'
        required: true
        default: 'chromeos-5.10-arcvm'
        type: choice
        options:
          - 'chromeos-5.10-arcvm'
          - 'chromeos-5.15-arcvm'
      
      ANDROID_VERSION:
        description: 'Select Android version'
        required: true
        default: 'android13'
        type: choice
        options:
          - 'android12'
          - 'android13'
          - 'android14'
          - 'android15'
      
      KERNEL_VERSION:
        description: 'Select kernel version'
        required: true
        default: '5.10'
        type: choice
        options:
          - '5.10'
          - '5.15'
          - '6.1'
          - '6.6'
      
      VFS_HOOKS:
        description: 'Enable VFS manual hooks'
        required: false
        type: boolean
        default: true
      
      KPM:
        description: 'Enable KPM (Kernel Patch Module)'
        required: false
        type: boolean
        default: true
      
      ZRAM:
        description: 'Enable ZRAM enhancement'
        required: false
        type: boolean
        default: true

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          
      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 git curl bc bison flex libssl-dev libelf-dev ccache \
            pkg-config zip unzip zlib1g-dev libglib2.0-dev binutils-dev libunwind-dev liblzma-dev lsb-release \
            linux-headers-$(uname -r) dwarves
          
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Clone kernel source
        run: |
          git clone --depth=1 -b ${{ github.event.inputs.KERNEL_BRANCH }} https://chromium.googlesource.com/chromiumos/third_party/kernel
          cd kernel
          
      - name: Clone SUSFS and Patch Repositories
        run: |
          echo "üì• Cloning SUSFS and patch repositories..."
          
          # Clone SUSFS repository with correct branch
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}
          
          # Clone SukiSU patch repository
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          
          if [ ! -d "susfs4ksu" ] || [ ! -d "SukiSU_patch" ]; then
            echo "‚ùå Failed to clone required repositories"
            exit 1
          fi
          
          echo "‚úÖ Successfully cloned required repositories"
          
          # Try multiple methods to clone SukiSU patch repository
          git clone https://${GH_TOKEN}@github.com/ShirkNeko/SukiSU_patch.git --depth=1 || \
          git clone https://github.com/ShirkNeko/SukiSU_patch.git --depth=1 || \
          git clone git://github.com/ShirkNeko/SukiSU_patch.git --depth=1 || \
          wget https://github.com/ShirkNeko/SukiSU_patch/archive/refs/heads/main.zip -O sukisu_patch.zip && \
          unzip sukisu_patch.zip && mv SukiSU_patch-main SukiSU_patch
          
          # Check if repositories were cloned successfully
          if [ ! -d "susfs4ksu" ] || [ ! -d "SukiSU_patch" ]; then
            echo "‚ùå Failed to clone required repositories"
            exit 1
          fi
          
          echo "‚úÖ Successfully cloned required repositories"

      # Apply SUSFS Patches
      - name: Apply SUSFS Patches to ChromeOS Kernel
        run: |
          cd kernel
          echo "üî® Applying SUSFS patches..."
          
          # Copy and apply SUSFS patches
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch ./
          cp -r ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp -r ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          
          patch -p1 < 50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch || true
          echo "‚úÖ SUSFS patches applied"

      # Apply Hide Stuff Patches
      - name: Apply Hide Stuff Patches
        run: |
          cd kernel
          cp ../SukiSU_patch/69_hide_stuff.patch ./
          echo "üî® Applying Hide Stuff patches..."
          patch -p1 -F 3 < 69_hide_stuff.patch
          echo "‚úÖ Hide Stuff patches applied"

      # Apply VFS Hooks if enabled
      - name: Apply VFS Hooks
        if: ${{ github.event.inputs.VFS == 'true' }}
        run: |
          cd kernel
          cp ../SukiSU_patch/hooks/syscall_hooks.patch ./
          echo "ÔøΩ Applying VFS hooks..."
          patch -p1 -F 3 < syscall_hooks.patch
          echo "‚úÖ VFS hooks applied"

      # Apply ZRAM enhancements if enabled
      - name: Apply ZRAM Enhancements
        if: ${{ github.event.inputs.ZRAM == 'true' }}
        run: |
          cd kernel
          echo "ÔøΩ Applying ZRAM enhancements..."
          
          # Copy ZRAM related files
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./lib
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto
          cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./lib/
          
          # Apply LZ4KD patch if kernel version matches
          cp ../SukiSU_patch/other/zram/zram_patch/${{ github.event.inputs.KERNEL_VERSION }}/lz4kd.patch ./
          patch -p1 -F 3 < lz4kd.patch || true
          echo "‚úÖ ZRAM enhancements applied"
          
      - name: Configure kernel
        run: |
          cd kernel
          # Create arch/x86/configs directory if it doesn't exist
          mkdir -p arch/x86/configs
          
          # Create compiler wrapper script to handle warnings
          cat > compiler-wrapper.sh << 'EOL'
          #!/bin/sh
          exec gcc -Wno-error=cast-function-type \
                  -Wno-error=format-truncation \
                  -Wno-error=format \
                  -Wno-error=missing-prototypes \
                  "$@"
          EOL
          chmod +x compiler-wrapper.sh
          
          # Set compiler wrapper
          export HOSTCC="./compiler-wrapper.sh"
          export CC="./compiler-wrapper.sh"
          
          # Create custom config
          cat > arch/x86/configs/chromiumos-x86_64_defconfig << 'EOL'
          CONFIG_X86_64=y
          CONFIG_64BIT=y
          CONFIG_SMP=y
          CONFIG_MODULES=y
          CONFIG_MODULE_UNLOAD=y
          CONFIG_MODVERSIONS=y
          CONFIG_PARTITION_ADVANCED=y
          CONFIG_EFI=y
          CONFIG_EFI_STUB=y
          CONFIG_FB=y
          CONFIG_FRAMEBUFFER_CONSOLE=y
          CONFIG_MAGIC_SYSRQ=y
          CONFIG_MAGIC_SYSRQ_DEFAULT_ENABLE=0x1
          CONFIG_MAGIC_SYSRQ_SERIAL=y
          CONFIG_EARLY_PRINTK=y
          CONFIG_RANDOMIZE_BASE=y
          CONFIG_ZBOOT_ROM_TEXT=0x0
          CONFIG_ZBOOT_ROM_BSS=0x0
          CONFIG_PROC_KCORE=y
          CONFIG_BLK_DEV_INITRD=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_WERROR=n
          CONFIG_VDSO=y
          CONFIG_GENERIC_TIME_VSYSCALL=y
          CONFIG_COMPAT_VDSO=y
          CONFIG_SYSVIPC=y
          CONFIG_POSIX_MQUEUE=y
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_MEMCG=y
          CONFIG_BLK_CGROUP=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_NAMESPACES=y
          CONFIG_SECURITY=y
          CONFIG_SECURITY_NETWORK=y
          CONFIG_HARDENED_USERCOPY=y
          CONFIG_STACKPROTECTOR_STRONG=y
          CONFIG_MODULES_TREE_LOOKUP=y
          EOL
          
          # Verify kernel/sched/rt.c exists and is writable
          if [ ! -w "kernel/sched/rt.c" ]; then
            echo "‚ö†Ô∏è Warning: kernel/sched/rt.c is not writable or doesn't exist"
            find . -name "rt.c" -type f
          fi
          
          # Create arch/x86/configs directory if it doesn't exist
          mkdir -p arch/x86/configs
          
          # Create base defconfig file
          cat > arch/x86/configs/chromiumos-x86_64_defconfig << 'EOL'
          CONFIG_X86_64=y
          CONFIG_64BIT=y
          CONFIG_SMP=y
          CONFIG_MODULES=y
          CONFIG_MODULE_UNLOAD=y
          CONFIG_MODVERSIONS=y
          CONFIG_PARTITION_ADVANCED=y
          CONFIG_EFI=y
          CONFIG_EFI_STUB=y
          CONFIG_FB=y
          CONFIG_FRAMEBUFFER_CONSOLE=y
          CONFIG_MAGIC_SYSRQ=y
          CONFIG_MAGIC_SYSRQ_DEFAULT_ENABLE=0x1
          CONFIG_MAGIC_SYSRQ_SERIAL=y
          CONFIG_EARLY_PRINTK=y
          CONFIG_RANDOMIZE_BASE=y
          CONFIG_ZBOOT_ROM_TEXT=0x0
          CONFIG_ZBOOT_ROM_BSS=0x0
          CONFIG_PROC_KCORE=y
          CONFIG_BLK_DEV_INITRD=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_LOCALVERSION="-SukiSU-Ultra"
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_SYSVIPC=y
          CONFIG_POSIX_MQUEUE=y
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_MEMCG=y
          CONFIG_BLK_CGROUP=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_NAMESPACES=y
          CONFIG_SECURITY=y
          CONFIG_SECURITY_NETWORK=y
          CONFIG_HARDENED_USERCOPY=y
          CONFIG_STACKPROTECTOR_STRONG=y
          CONFIG_MODULES_TREE_LOOKUP=y
          EOL
          
          # Apply base configuration
          make ARCH=x86_64 chromiumos-x86_64_defconfig
          
          # Configure additional kernel options
          cat >> .config << 'EOL'
          CONFIG_KSU=y
          CONFIG_KPM=y
          CONFIG_LOCALVERSION="-SukiSU-Ultra"
          CONFIG_LOCALVERSION_AUTO=n
          EOL
          
          # Enable VFS hooks if requested
          if [[ "${{ github.event.inputs.VFS_HOOKS }}" == "true" ]]; then
            echo "CONFIG_KSU_MANUAL_HOOK=y" >> .config
          fi
          
          # Update configuration
          make ARCH=x86_64 olddefconfig
          
      - name: Build kernel
        run: |
          cd kernel
          echo "Building kernel with $(nproc) cores..."
          
          # Fix function prototype in vgetcpu.c
          echo 'long __vdso_getcpu(unsigned *cpu, unsigned *node, struct getcpu_cache *unused);' > arch/x86/entry/vdso/vgetcpu.h
          sed -i '1i#include "vgetcpu.h"' arch/x86/entry/vdso/vgetcpu.c
          
          # Fix function cast in sock.h
          sed -i 's/android_dst_ops_negative_advice_new_t/void (*)(struct sock *, struct dst_entry *)/' include/net/sock.h
          
          # Set additional compiler flags to handle warnings
          export KCFLAGS="-Wno-error=cast-function-type -Wno-error=format-truncation -Wno-error=format -Wno-error=missing-prototypes"
          export KCPPFLAGS="-P"
          
          # First try with standard options
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) all W=1 \
            KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS" || \
          # If failed, try with additional debug options
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) V=1 W=1 \
            KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS"
          
          # Build modules and bzImage
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) bzImage modules \
            KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS"
          
          if [ ! -f "arch/x86/boot/bzImage" ]; then
            echo "‚ùå Kernel build failed - bzImage not found"
            echo "Dumping last 100 lines of build log..."
            tail -n 100 .build.log
            exit 1
          fi
          
          echo "‚úÖ Kernel build completed successfully"
          
      - name: Package kernel and source tree
        run: |
          echo "üì¶ Creating kernel packages..."
          
          # Create compiled kernel package
          echo "Creating compiled kernel package..."
          mkdir -p dist/kernel
          cp kernel/arch/x86/boot/bzImage dist/kernel/
          cp kernel/System.map dist/kernel/
          cp -r kernel/include dist/kernel/
          
          cd dist
          zip -r ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip kernel/
          echo "‚úÖ Compiled kernel package prepared"
          
          # Create source tree package
          echo "Creating source tree package..."
          cd ..
          echo "Preparing source tree for packaging..."
          
          # Clean build artifacts before packaging source
          cd kernel
          make clean
          
          # Create source package directory
          cd ..
          mkdir -p dist/source_tree
          
          # Copy the complete modified kernel source
          cp -r kernel/* dist/source_tree/
          
          # Create source tree archive
          cd dist
          tar -czf ARCVM-x86_64-SUKISU-ULTRA-SUSFS-ROOTED-KERNEL-SOURCE.tar.gz source_tree/
          echo "‚úÖ Source tree package prepared"
          
      - name: Upload compiled kernel package
        uses: actions/upload-artifact@v4
        with:
          name: compiled-kernel
          path: dist/ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip
          compression-level: 9
          retention-days: 90
          
      - name: Upload source tree package
        uses: actions/upload-artifact@v4
        with:
          name: kernel-source-tree
          path: dist/ARCVM-x86_64-SUKISU-ULTRA-SUSFS-ROOTED-KERNEL-SOURCE.tar.gz
          compression-level: 9
          retention-days: 90
