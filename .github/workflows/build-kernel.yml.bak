name: Build ChromeOS ARCVM Kernel with SukiSU Ultra + SUSFS
name: Build ChromeOS ARCVM Kernel with SukiSU Ultra + SUSFS


on:
on:
  workflow_dispatch:
  workflow_dispatch:
    inputs:
    inputs:
      KERNEL_BRANCH:
      KERNEL_BRANCH:
        description: 'Select kernel branch'
        description: 'Select kernel branch'
        required: true
        required: true
        default: 'chromeos-5.10-arcvm'
        default: 'chromeos-5.10-arcvm'
        type: choice
        type: choice
        options:
        options:
          - 'chromeos-5.10-arcvm'
          - 'chromeos-5.10-arcvm'
          - 'chromeos-5.15-arcvm'
          - 'chromeos-5.15-arcvm'
      
      
      ANDROID_VERSION:
      ANDROID_VERSION:
        description: 'Select Android version'
        description: 'Select Android version'
        required: true
        required: true
        default: 'android13'
        default: 'android13'
        type: choice
        type: choice
        options:
        options:
          - 'android12'
          - 'android12'
          - 'android13'
          - 'android13'
          - 'android14'
          - 'android14'
          - 'android15'
          - 'android15'
      
      
      KERNEL_VERSION:
      KERNEL_VERSION:
        description: 'Select kernel version'
        description: 'Select kernel version'
        required: true
        required: true
        default: '5.10'
        default: '5.10'
        type: choice
        type: choice
        options:
        options:
          - '5.10'
          - '5.10'
          - '5.15'
          - '5.15'
          - '6.1'
          - '6.1'
          - '6.6'
          - '6.6'
      
      
      VFS_HOOKS:
      VFS_HOOKS:
        description: 'Enable VFS manual hooks'
        description: 'Enable VFS manual hooks'
        required: false
        required: false
        type: boolean
        type: boolean
        default: true
        default: true
      
      
      KPM:
      KPM:
        description: 'Enable KPM (Kernel Patch Module)'
        description: 'Enable KPM (Kernel Patch Module)'
        required: false
        required: false
        type: boolean
        type: boolean
        default: true
        default: true
      
      
      ZRAM:
      ZRAM:
        description: 'Enable ZRAM enhancement'
        description: 'Enable ZRAM enhancement'
        required: false
        required: false
        type: boolean
        type: boolean
        default: true
        default: true


jobs:
jobs:
  build-kernel:
  build-kernel:
    runs-on: ubuntu-latest
    runs-on: ubuntu-latest
    
    
    steps:
    steps:
      - name: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        uses: actions/checkout@v3
        with:
        with:
          fetch-depth: 1
          fetch-depth: 1
          
          
      - name: Setup build environment
      - name: Setup build environment
        run: |
        run: |
          echo "üîÑ Updating package lists..."
          echo "üîÑ Updating package lists..."
          sudo apt-get update
          sudo apt-get update
          
          
          echo "üì¶ Installing build dependencies..."
          echo "üì¶ Installing build dependencies..."
          sudo apt-get install -y build-essential python3 git curl bc bison flex libssl-dev libelf-dev ccache \
          sudo apt-get install -y build-essential python3 git curl bc bison flex libssl-dev libelf-dev ccache \
          pkg-config zip unzip zlib1g-dev libglib2.0-dev binutils-dev libunwind-dev liblzma-dev lsb-release \
          pkg-config zip unzip zlib1g-dev libglib2.0-dev binutils-dev libunwind-dev liblzma-dev lsb-release \
          linux-headers-$(uname -r) dwarves
          linux-headers-$(uname -r) dwarves
          
          
          echo "üîç Verifying installed packages..."
          echo "üîç Verifying installed packages..."
          for pkg in gcc make python3 git curl bc bison flex ccache; do
          for pkg in gcc make python3 git curl bc bison flex ccache; do
          if ! command -v $pkg &> /dev/null; then
          if ! command -v $pkg &> /dev/null; then
          echo "‚ùå Required tool $pkg not found!"
          echo "‚ùå Required tool $pkg not found!"
          exit 1
          exit 1
          fi
          fi
          done
          done
          
          
          echo "‚úÖ Build environment setup complete"
          echo "‚úÖ Build environment setup complete"
          
          
      - name: Configure Git
      - name: Configure Git
        run: |
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global user.email "actions@github.com"
          
          
      - name: Prepare workspace
      - name: Prepare workspace
        run: |
        run: |
          echo "üîÑ Preparing workspace..."
          echo "üîÑ Preparing workspace..."
          mkdir -p kernel_workspace/kernel_platform
          mkdir -p kernel_workspace/kernel_platform
          cd kernel_workspace
          cd kernel_workspace
          
          
      - name: Clone kernel source
      - name: Clone kernel source
        run: |
        run: |
          cd kernel_workspace/kernel_platform
          cd kernel_workspace/kernel_platform
          echo "üì• Cloning kernel source..."
          echo "üì• Cloning kernel source..."
          
          
          echo "üìÇ Working in build directory: $BUILD_DIR"
          echo "üìÇ Working in build directory: $BUILD_DIR"
          
          
          # Clone with retry mechanism
          # Clone with retry mechanism
          MAX_RETRIES=3
          MAX_RETRIES=3
          RETRY_COUNT=0
          RETRY_COUNT=0
          
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "üì• Cloning kernel source (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
          echo "üì• Cloning kernel source (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
          if git clone --depth=1 -b ${{ github.event.inputs.KERNEL_BRANCH }} \
          if git clone --depth=1 -b ${{ github.event.inputs.KERNEL_BRANCH }} \
          https://chromium.googlesource.com/chromiumos/third_party/kernel source; then
          https://chromium.googlesource.com/chromiumos/third_party/kernel source; then
          echo "‚úÖ Kernel source cloned successfully"
          echo "‚úÖ Kernel source cloned successfully"
          break
          break
          else
          else
          RETRY_COUNT=$((RETRY_COUNT + 1))
          RETRY_COUNT=$((RETRY_COUNT + 1))
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "‚ùå Failed to clone kernel after $MAX_RETRIES attempts"
          echo "‚ùå Failed to clone kernel after $MAX_RETRIES attempts"
          exit 1
          exit 1
          fi
          fi
          echo "‚ö†Ô∏è Clone failed, retrying in 5 seconds..."
          echo "‚ö†Ô∏è Clone failed, retrying in 5 seconds..."
          sleep 5
          sleep 5
          fi
          fi
          done
          done
          
          
          # Verify clone success and enter directory
          # Verify clone success and enter directory
          if [ ! -d "source" ]; then
          if [ ! -d "source" ]; then
          echo "‚ùå Kernel source directory not found after clone"
          echo "‚ùå Kernel source directory not found after clone"
          exit 1
          exit 1
          fi
          fi
          
          
          cd source
          cd source
          
          
          # Verify branch checkout
          # Verify branch checkout
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$CURRENT_BRANCH" != "${{ github.event.inputs.KERNEL_BRANCH }}" ]; then
          if [ "$CURRENT_BRANCH" != "${{ github.event.inputs.KERNEL_BRANCH }}" ]; then
          echo "‚ùå Wrong branch checked out: $CURRENT_BRANCH (expected: ${{ github.event.inputs.KERNEL_BRANCH }})"
          echo "‚ùå Wrong branch checked out: $CURRENT_BRANCH (expected: ${{ github.event.inputs.KERNEL_BRANCH }})"
          exit 1
          exit 1
          fi
          fi
          
          
          # Log repository info
          # Log repository info
          echo "üìã Kernel repository information:"
          echo "üìã Kernel repository information:"
          echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Date: $(git log -1 --format='%cd')"
          echo "Date: $(git log -1 --format='%cd')"
          
          
      - name: Clone SUSFS and Patch Repositories
      - name: Clone SUSFS and Patch Repositories
        run: |
        run: |
          set -euo pipefail
          set -euo pipefail


          echo "üì• Cloning SUSFS and patch repositories into kernel_workspace..."
          echo "üì• Cloning SUSFS and patch repositories into kernel_workspace..."
          mkdir -p kernel_workspace
          mkdir -p kernel_workspace
          cd kernel_workspace
          cd kernel_workspace


          # SUSFS repo settings
          # SUSFS repo settings
          SUSFS_URL="https://gitlab.com/simonpunk/susfs4ksu.git"
          SUSFS_URL="https://gitlab.com/simonpunk/susfs4ksu.git"
          SUSFS_BRANCH="gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}"
          SUSFS_BRANCH="gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}"


          echo "‚è≥ Checking for SUSFS branch $SUSFS_BRANCH ..."
          echo "‚è≥ Checking for SUSFS branch $SUSFS_BRANCH ..."
          AVAILABLE_BRANCHES=$(git ls-remote --heads "$SUSFS_URL" | sed 's/.*refs\/heads\///' || true)
          AVAILABLE_BRANCHES=$(git ls-remote --heads "$SUSFS_URL" | sed 's/.*refs\/heads\///' || true)
          echo "Available branches for SUSFS:"
          echo "Available branches for SUSFS:"
          echo "$AVAILABLE_BRANCHES"
          echo "$AVAILABLE_BRANCHES"
          if ! echo "$AVAILABLE_BRANCHES" | grep -wq "$SUSFS_BRANCH"; then
          if ! echo "$AVAILABLE_BRANCHES" | grep -wq "$SUSFS_BRANCH"; then
          echo "‚ùå Branch $SUSFS_BRANCH not found in SUSFS repo!"
          echo "‚ùå Branch $SUSFS_BRANCH not found in SUSFS repo!"
          exit 1
          exit 1
          fi
          fi


          # Robust clone with cleanup/retries
          # Robust clone with cleanup/retries
          MAX_RETRIES=3
          MAX_RETRIES=3
          n=0
          n=0
          while [ $n -lt $MAX_RETRIES ]; do
          while [ $n -lt $MAX_RETRIES ]; do
          echo "Attempt $((n+1)): git clone --depth=1 -b \"$SUSFS_BRANCH\" \"$SUSFS_URL\" susfs4ksu"
          echo "Attempt $((n+1)): git clone --depth=1 -b \"$SUSFS_BRANCH\" \"$SUSFS_URL\" susfs4ksu"
          if git clone --depth=1 -b "$SUSFS_BRANCH" "$SUSFS_URL" susfs4ksu; then
          if git clone --depth=1 -b "$SUSFS_BRANCH" "$SUSFS_URL" susfs4ksu; then
          echo "‚úÖ SUSFS repository cloned successfully"
          echo "‚úÖ SUSFS repository cloned successfully"
          break
          break
          else
          else
          echo "‚ö†Ô∏è SUSFS clone failed, cleaning folder and retrying in 5s..."
          echo "‚ö†Ô∏è SUSFS clone failed, cleaning folder and retrying in 5s..."
          rm -rf susfs4ksu
          rm -rf susfs4ksu
          sleep 5
          sleep 5
          fi
          fi
          n=$((n+1))
          n=$((n+1))
          done
          done


          if [ ! -d susfs4ksu ]; then
          if [ ! -d susfs4ksu ]; then
          echo "‚ùå susfs4ksu directory missing after clone!"
          echo "‚ùå susfs4ksu directory missing after clone!"
          ls -la
          ls -la
          exit 1
          exit 1
          fi
          fi


          cd susfs4ksu
          cd susfs4ksu
          echo "Current SUSFS branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Current SUSFS branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "SUSFS relevant files listing:"
          echo "SUSFS relevant files listing:"
          ls -la kernel_patches || true
          ls -la kernel_patches || true
          ls -la kernel_patches/fs || true
          ls -la kernel_patches/fs || true
          ls -la kernel_patches/include/linux || true
          ls -la kernel_patches/include/linux || true
          cd ..
          cd ..


          # SukiSU_patch repo settings
          # SukiSU_patch repo settings
          PATCH_URL="https://github.com/ShirkNeko/SukiSU_patch.git"
          PATCH_URL="https://github.com/ShirkNeko/SukiSU_patch.git"
          MAX_RETRIES=2
          MAX_RETRIES=2
          n=0
          n=0
          until [ $n -ge $MAX_RETRIES ]; do
          until [ $n -ge $MAX_RETRIES ]; do
          echo "Attempt $((n+1)): cloning SukiSU_patch repo..."
          echo "Attempt $((n+1)): cloning SukiSU_patch repo..."
          if git clone --depth=1 "$PATCH_URL" SukiSU_patch; then
          if git clone --depth=1 "$PATCH_URL" SukiSU_patch; then
          echo "‚úÖ SukiSU_patch repo cloned."
          echo "‚úÖ SukiSU_patch repo cloned."
          break
          break
          else
          else
          echo "‚ö†Ô∏è SukiSU_patch clone failed, retrying in 5s..."
          echo "‚ö†Ô∏è SukiSU_patch clone failed, retrying in 5s..."
          rm -rf SukiSU_patch
          rm -rf SukiSU_patch
          sleep 5
          sleep 5
          fi
          fi
          n=$((n+1))
          n=$((n+1))
          done
          done


          if [ ! -d SukiSU_patch ]; then
          if [ ! -d SukiSU_patch ]; then
          echo "‚ùå SukiSU_patch directory missing after clone!"
          echo "‚ùå SukiSU_patch directory missing after clone!"
          ls -la
          ls -la
          exit 1
          exit 1
          fi
          fi


          # Final verification for required files
          # Final verification for required files
          PATCH1="susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch"
          PATCH1="susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch"
          PATCH2="SukiSU_patch/69_hide_stuff.patch"
          PATCH2="SukiSU_patch/69_hide_stuff.patch"
          if [ ! -f "$PATCH1" ]; then
          if [ ! -f "$PATCH1" ]; then
          echo "‚ùå Required SUSFS patch missing: $PATCH1"
          echo "‚ùå Required SUSFS patch missing: $PATCH1"
          ls -la susfs4ksu/kernel_patches/
          ls -la susfs4ksu/kernel_patches/
          exit 1
          exit 1
          fi
          fi
          if [ ! -f "$PATCH2" ]; then
          if [ ! -f "$PATCH2" ]; then
          echo "‚ùå Required SukiSU 'Hide Stuff' patch missing: $PATCH2"
          echo "‚ùå Required SukiSU 'Hide Stuff' patch missing: $PATCH2"
          ls -la SukiSU_patch/
          ls -la SukiSU_patch/
          exit 1
          exit 1
          fi
          fi
          echo "‚úÖ Both main patch files are present."
          echo "‚úÖ Both main patch files are present."


      - name: Apply SUSFS Patches to ChromeOS Kernel
      - name: Apply SUSFS Patches to ChromeOS Kernel
        run: |
        run: |
          set -euo pipefail
          set -euo pipefail


          cd kernel_workspace/kernel_platform
          cd kernel_workspace/kernel_platform
          echo "üî® Preparing SUSFS patches..."
          echo "üî® Preparing SUSFS patches..."
          
          
          # Create backup directory
          # Create backup directory
          BACKUP_DIR="backup_$(date +%Y%m%d_%H%M%S)"
          BACKUP_DIR="backup_$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          mkdir -p "$BACKUP_DIR"


          # Enter source directory where patches will be applied
          # Enter source directory where patches will be applied
          cd source
          cd source
          
          
          # Create backup of target directories
          # Create backup of target directories
          for dir in fs include/linux; do
          for dir in fs include/linux; do
          if [ -d "$dir" ]; then
          if [ -d "$dir" ]; then
          echo "üì¶ Backing up $dir..."
          echo "üì¶ Backing up $dir..."
          cp -r "$dir" "../$BACKUP_DIR/"
          cp -r "$dir" "../$BACKUP_DIR/"
          fi
          fi
          done
          done


          # Locate SUSFS patch
          # Locate SUSFS patch
          PATCH_FILE="../../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch"
          PATCH_FILE="../../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch"
          if [ ! -f "$PATCH_FILE" ]; then
          if [ ! -f "$PATCH_FILE" ]; then
          echo "‚ùå SUSFS patch file not found: $PATCH_FILE"
          echo "‚ùå SUSFS patch file not found: $PATCH_FILE"
          ls -la ../../susfs4ksu/kernel_patches/
          ls -la ../../susfs4ksu/kernel_patches/
          exit 1
          exit 1
          fi
          fi


          echo "üîé Patch preview (first 120 lines):"
          echo "üîé Patch preview (first 120 lines):"
          sed -n '1,120p' "$PATCH_FILE" || true
          sed -n '1,120p' "$PATCH_FILE" || true
          echo "üîç Attempting git apply --3way first..."
          echo "üîç Attempting git apply --3way first..."


          # Try git apply --3way first (best for git-origin patches)
          # Try git apply --3way first (best for git-origin patches)
          if git apply --3way --index --check "$PATCH_FILE" 2>&1 | tee git_apply_check.log; then
          if git apply --3way --index --check "$PATCH_FILE" 2>&1 | tee git_apply_check.log; then
          echo "‚úÖ git apply check succeeded; applying --3way..."
          echo "‚úÖ git apply check succeeded; applying --3way..."
          git apply --3way --index "$PATCH_FILE"
          git apply --3way --index "$PATCH_FILE"
          else
          else
          echo "‚ö†Ô∏è git apply failed; trying patch utility with auto-detect..."
          echo "‚ö†Ô∏è git apply failed; trying patch utility with auto-detect..."
            
            
          # Copy required SUSFS files first
          # Copy required SUSFS files first
          echo "üìÇ Copying SUSFS files..."
          echo "üìÇ Copying SUSFS files..."
          mkdir -p fs include/linux
          mkdir -p fs include/linux
          cp -rf ../../susfs4ksu/kernel_patches/fs/* fs/
          cp -rf ../../susfs4ksu/kernel_patches/fs/* fs/
          cp -rf ../../susfs4ksu/kernel_patches/include/linux/* include/linux/
          cp -rf ../../susfs4ksu/kernel_patches/include/linux/* include/linux/
            
            
          # Try patch with different -p levels
          # Try patch with different -p levels
          APPLIED=0
          APPLIED=0
          for P in 0 1 2 3; do
          for P in 0 1 2 3; do
          echo "üîÑ Trying patch -p$P..."
          echo "üîÑ Trying patch -p$P..."
          if patch --dry-run -p$P < "$PATCH_FILE" > patch_test_p${P}.log 2>&1; then
          if patch --dry-run -p$P < "$PATCH_FILE" > patch_test_p${P}.log 2>&1; then
          echo "‚úÖ patch -p$P dry-run OK; applying..."
          echo "‚úÖ patch -p$P dry-run OK; applying..."
          if patch -p$P < "$PATCH_FILE"; then
          if patch -p$P < "$PATCH_FILE"; then
          APPLIED=1
          APPLIED=1
          break
          break
          fi
          fi
          fi
          fi
          done
          done


          if [ $APPLIED -eq 0 ]; then
          if [ $APPLIED -eq 0 ]; then
          echo "‚ùå All patch attempts failed. Diagnostics:"
          echo "‚ùå All patch attempts failed. Diagnostics:"
          echo "=== git apply check log ==="
          echo "=== git apply check log ==="
          cat git_apply_check.log || true
          cat git_apply_check.log || true
          for f in patch_test_p*.log; do
          for f in patch_test_p*.log; do
          echo "=== $f ==="
          echo "=== $f ==="
          cat "$f" || true
          cat "$f" || true
          done
          done
              
              
          echo "Restoring backups..."
          echo "Restoring backups..."
          for dir in fs include/linux; do
          for dir in fs include/linux; do
          if [ -d "../$BACKUP_DIR/$dir" ]; then
          if [ -d "../$BACKUP_DIR/$dir" ]; then
          rm -rf "$dir"
          rm -rf "$dir"
          cp -r "../$BACKUP_DIR/$dir" .
          cp -r "../$BACKUP_DIR/$dir" .
          fi
          fi
          done
          done
          exit 1
          exit 1
          fi
          fi
          fi
          fi


          # Final verification
          # Final verification
          if git diff --check; then
          if git diff --check; then
          echo "‚úÖ SUSFS patches applied successfully with clean diff"
          echo "‚úÖ SUSFS patches applied successfully with clean diff"
          else
          else
          echo "‚ö†Ô∏è SUSFS patches applied but found whitespace issues"
          echo "‚ö†Ô∏è SUSFS patches applied but found whitespace issues"
          fi
          fi


          # Apply Hide Stuff Patches
          # Apply Hide Stuff Patches
      - name: Apply Hide Stuff Patches
      - name: Apply Hide Stuff Patches
        run: |
        run: |
          set -euo pipefail
          set -euo pipefail


          cd kernel_workspace/kernel_platform
          cd kernel_workspace/kernel_platform
          echo "üî® Applying Hide Stuff patches (SukiSU_patch/69_hide_stuff.patch)..."
          echo "üî® Applying Hide Stuff patches (SukiSU_patch/69_hide_stuff.patch)..."


          PATCH_SRC="../SukiSU_patch/69_hide_stuff.patch"
          PATCH_SRC="../SukiSU_patch/69_hide_stuff.patch"
          if [ ! -f "$PATCH_SRC" ]; then          if [ ! -f "$PATCH_SRC" ]; then
          if [ ! -f "$PATCH_SRC" ]; then          if [ ! -f "$PATCH_SRC" ]; then
          echo "‚ùå Hide Stuff patch not found: $PATCH_SRC"
          echo "‚ùå Hide Stuff patch not found: $PATCH_SRC"
          ls -la ../SukiSU_patch || true
          ls -la ../SukiSU_patch || true
          exit 1
          exit 1
          fi
          fi


          # Work in ./common where SUSFS files were placed
          # Work in ./common where SUSFS files were placed
          cd ./common
          cd ./common


          echo "Saving pre-patch state..."
          echo "Saving pre-patch state..."
          git -c user.name="GitHub Actions" -c user.email="actions@github.com" add -A || true
          git -c user.name="GitHub Actions" -c user.email="actions@github.com" add -A || true
          git -c user.name="GitHub Actions" -c user.email="actions@github.com" commit -m "Save state before Hide Stuff patch" || true
          git -c user.name="GitHub Actions" -c user.email="actions@github.com" commit -m "Save state before Hide Stuff patch" || true


          echo "Patch head:"
          echo "Patch head:"
          sed -n '1,80p' "$PATCH_SRC" || true
          sed -n '1,80p' "$PATCH_SRC" || true


          # Prefer git apply --3way
          # Prefer git apply --3way
          if git apply --3way --index --check "$PATCH_SRC" 2>&1 | tee hide_git_check.log; then
          if git apply --3way --index --check "$PATCH_SRC" 2>&1 | tee hide_git_check.log; then
          echo "‚úÖ git apply --check succeeded; applying --3way..."
          echo "‚úÖ git apply --check succeeded; applying --3way..."
          git apply --3way --index "$PATCH_SRC"
          git apply --3way --index "$PATCH_SRC"
          else
          else
          echo "‚ö†Ô∏è git apply failed; trying patch -p levels..."
          echo "‚ö†Ô∏è git apply failed; trying patch -p levels..."
          APPLIED=0
          APPLIED=0
          for P in 0 1 2 3; do
          for P in 0 1 2 3; do
          echo "Trying patch -p$P ..."
          echo "Trying patch -p$P ..."
          if patch --dry-run -p$P < "$PATCH_SRC" > hide_patch_test_p${P}.log 2>&1; then
          if patch --dry-run -p$P < "$PATCH_SRC" > hide_patch_test_p${P}.log 2>&1; then
          echo "‚úÖ patch -p$P dry-run OK; applying..."
          echo "‚úÖ patch -p$P dry-run OK; applying..."
          patch -p$P < "$PATCH_SRC"
          patch -p$P < "$PATCH_SRC"
          APPLIED=1
          APPLIED=1
          break
          break
          else
          else
          echo "‚Üí patch -p$P failed; see hide_patch_test_p${P}.log"
          echo "‚Üí patch -p$P failed; see hide_patch_test_p${P}.log"
          fi
          fi
          done
          done
          if [ $APPLIED -eq 0 ]; then
          if [ $APPLIED -eq 0 ]; then
          echo "‚ùå Failed to apply Hide Stuff patch. Diagnostics:"
          echo "‚ùå Failed to apply Hide Stuff patch. Diagnostics:"
          sed -n '1,200p' hide_git_check.log || true
          sed -n '1,200p' hide_git_check.log || true
          for f in hide_patch_test_*.log; do sed -n '1,200p' "$f" || true; done
          for f in hide_patch_test_*.log; do sed -n '1,200p' "$f" || true; done
          exit 1
          exit 1
          fi
          fi
          fi
          fi


          echo "Verifying patch application (git diff --check)..."
          echo "Verifying patch application (git diff --check)..."
          if ! git diff --check; then
          if ! git diff --check; then
          echo "‚ö†Ô∏è Warning: whitespace or other issues found in diff --check"
          echo "‚ö†Ô∏è Warning: whitespace or other issues found in diff --check"
          fi
          fi
          echo "‚úÖ Hide Stuff patch applied"
          echo "‚úÖ Hide Stuff patch applied"


          # Apply VFS Hooks if enabled
          # Apply VFS Hooks if enabled
      - name: Apply VFS Hooks
      - name: Apply VFS Hooks
        if: ${{ github.event.inputs.VFS_HOOKS == 'true' }}
        run: |
        run: |
          set -euo pipefail
          set -euo pipefail


          cd kernel_workspace/kernel_platform
          cd kernel_workspace/kernel_platform
          echo "üîß Preparing VFS hooks..."
          echo "üîß Preparing VFS hooks..."


          HOOK_PATCH="../SukiSU_patch/hooks/syscall_hooks.patch"
          HOOK_PATCH="../SukiSU_patch/hooks/syscall_hooks.patch"
          if [ ! -f "$HOOK_PATCH" ]; then
          if [ ! -f "$HOOK_PATCH" ]; then
          echo "‚ùå VFS hooks patch not found: $HOOK_PATCH"
          echo "‚ùå VFS hooks patch not found: $HOOK_PATCH"
          ls -la ../SukiSU_patch/hooks || true
          ls -la ../SukiSU_patch/hooks || true
          exit 1
          exit 1
          fi
          fi


          # Save state
          # Save state
          cd common
          cd common
          git -c user.name="GitHub Actions" -c user.email="actions@github.com" add -A || true
          git -c user.name="GitHub Actions" -c user.email="actions@github.com" add -A || true
          git -c user.name="GitHub Actions" -c user.email="actions@github.com" commit -m "Save state before VFS hooks" || true
          git -c user.name="GitHub Actions" -c user.email="actions@github.com" commit -m "Save state before VFS hooks" || true


          echo "Preview hooks patch:"
          echo "Preview hooks patch:"
          sed -n '1,80p' "$HOOK_PATCH" || true
          sed -n '1,80p' "$HOOK_PATCH" || true


          # Try git apply --3way first
          # Try git apply --3way first
          if git apply --3way --index --check "$HOOK_PATCH" 2>&1 | tee vfs_git_check.log; then
          if git apply --3way --index --check "$HOOK_PATCH" 2>&1 | tee vfs_git_check.log; then
          echo "‚úÖ git apply check succeeded; applying --3way..."
          echo "‚úÖ git apply check succeeded; applying --3way..."
          git apply --3way --index "$HOOK_PATCH"
          git apply --3way --index "$HOOK_PATCH"
          else
          else
          echo "‚ö†Ô∏è git apply failed; attempting patch -p auto-detect..."
          echo "‚ö†Ô∏è git apply failed; attempting patch -p auto-detect..."
          APPLIED=0
          APPLIED=0
          for P in 0 1 2 3; do
          for P in 0 1 2 3; do
          echo "Trying patch -p$P ..."
          echo "Trying patch -p$P ..."
          if patch --dry-run -p$P < "$HOOK_PATCH" > vfs_patch_test_p${P}.log 2>&1; then
          if patch --dry-run -p$P < "$HOOK_PATCH" > vfs_patch_test_p${P}.log 2>&1; then
          echo "‚úÖ patch -p$P dry-run OK; applying..."
          echo "‚úÖ patch -p$P dry-run OK; applying..."
          patch -p$P < "$HOOK_PATCH"
          patch -p$P < "$HOOK_PATCH"
          APPLIED=1
          APPLIED=1
          break
          break
          else
          else
          echo "‚Üí patch -p$P failed (see vfs_patch_test_p${P}.log)"
          echo "‚Üí patch -p$P failed (see vfs_patch_test_p${P}.log)"
          fi
          fi
          done
          done
          if [ $APPLIED -eq 0 ]; then
          if [ $APPLIED -eq 0 ]; then
          echo "‚ùå Failed to apply VFS hooks patch. Diagnostics:"
          echo "‚ùå Failed to apply VFS hooks patch. Diagnostics:"
          sed -n '1,200p' vfs_git_check.log || true
          sed -n '1,200p' vfs_git_check.log || true
          for f in vfs_patch_test_*.log; do sed -n '1,200p' "$f" || true; done
          for f in vfs_patch_test_*.log; do sed -n '1,200p' "$f" || true; done
          git reset --hard HEAD || true
          git reset --hard HEAD || true
          exit 1
          exit 1
          fi
          fi
          fi
          fi


          echo "Verifying VFS hooks (git diff --check)..."
          echo "Verifying VFS hooks (git diff --check)..."
          if ! git diff --check; then
          if ! git diff --check; then
          echo "‚ö†Ô∏è Warning: VFS hooks patch verification found whitespace errors"
          echo "‚ö†Ô∏è Warning: VFS hooks patch verification found whitespace errors"
          fi
          fi
          echo "‚úÖ VFS hooks applied successfully"
          echo "‚úÖ VFS hooks applied successfully"


          # Apply ZRAM enhancements if enabled
          # Apply ZRAM enhancements if enabled
      - name: Apply ZRAM Enhancements
      - name: Apply ZRAM Enhancements
        if: ${{ github.event.inputs.ZRAM == 'true' }}
        run: |
        run: |
          set -euo pipefail
          set -euo pipefail


          cd kernel_workspace/kernel_platform
          cd kernel_workspace/kernel_platform
          echo "üîß Preparing ZRAM enhancements..."
          echo "üîß Preparing ZRAM enhancements..."


          # Validate ZRAM directories in patch repo
          # Validate ZRAM directories in patch repo
          ZRAM_BASE="../SukiSU_patch/other/zram/lz4k"
          ZRAM_BASE="../SukiSU_patch/other/zram/lz4k"
          REQUIRED_DIRS=( "include/linux" "lib" "crypto" )
          REQUIRED_DIRS=( "include/linux" "lib" "crypto" )
          for dir in "${REQUIRED_DIRS[@]}"; do
          for dir in "${REQUIRED_DIRS[@]}"; do
          if [ ! -d "${ZRAM_BASE}/${dir}" ]; then
          if [ ! -d "${ZRAM_BASE}/${dir}" ]; then
          echo "‚ùå ZRAM source directory missing: ${ZRAM_BASE}/${dir}"
          echo "‚ùå ZRAM source directory missing: ${ZRAM_BASE}/${dir}"
          ls -la "${ZRAM_BASE}" || true
          ls -la "${ZRAM_BASE}" || true
          exit 1
          exit 1
          fi
          fi
          done
          done


          # Create backups of target directories (if they exist)
          # Create backups of target directories (if they exist)
          for dir in "${REQUIRED_DIRS[@]}"; do
          for dir in "${REQUIRED_DIRS[@]}"; do
          if [ -d "$dir" ]; then
          if [ -d "$dir" ]; then
          tar czf "../${dir//\//_}_backup_$(date +%Y%m%d_%H%M%S).tar.gz" "$dir/"
          tar czf "../${dir//\//_}_backup_$(date +%Y%m%d_%H%M%S).tar.gz" "$dir/"
          fi
          fi
          done
          done


          echo "üì¶ Copying ZRAM files..."
          echo "üì¶ Copying ZRAM files..."
          for src in "${REQUIRED_DIRS[@]}"; do
          for src in "${REQUIRED_DIRS[@]}"; do
          SRC_PATH="${ZRAM_BASE}/${src}"
          SRC_PATH="${ZRAM_BASE}/${src}"
          DEST_PATH="./${src%/*}" # e.g. include/linux -> ./include
          DEST_PATH="./${src%/*}" # e.g. include/linux -> ./include
          mkdir -p "$DEST_PATH"
          mkdir -p "$DEST_PATH"
          if ! cp -r "$SRC_PATH"/* "$DEST_PATH/"; then
          if ! cp -r "$SRC_PATH"/* "$DEST_PATH/"; then
          echo "‚ùå Failed to copy ZRAM files from $SRC_PATH"
          echo "‚ùå Failed to copy ZRAM files from $SRC_PATH"
          echo "Restoring backups..."
          echo "Restoring backups..."
          for backup in ../*_backup_*.tar.gz; do
          for backup in ../*_backup_*.tar.gz; do
          if [ -f "$backup" ]; then tar xzf "$backup"; fi
          if [ -f "$backup" ]; then tar xzf "$backup"; fi
          done
          done
          exit 1
          exit 1
          fi
          fi
          done
          done


          # Copy optional lz4k_oplus dir if present
          # Copy optional lz4k_oplus dir if present
          if [ -d "../SukiSU_patch/other/zram/lz4k_oplus" ]; then
          if [ -d "../SukiSU_patch/other/zram/lz4k_oplus" ]; then
          echo "Copying lz4k_oplus..."
          echo "Copying lz4k_oplus..."
          mkdir -p lib
          mkdir -p lib
          cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./lib/ || true
          cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./lib/ || true
          else
          else
          echo "‚ö†Ô∏è lz4k_oplus not present, skipping..."
          echo "‚ö†Ô∏è lz4k_oplus not present, skipping..."
          fi
          fi


          # Apply LZ4KD patch if present
          # Apply LZ4KD patch if present
          ZRAM_PATCH="../SukiSU_patch/other/zram/zram_patch/${{ github.event.inputs.KERNEL_VERSION }}/lz4kd.patch"
          ZRAM_PATCH="../SukiSU_patch/other/zram/zram_patch/${{ github.event.inputs.KERNEL_VERSION }}/lz4kd.patch"
          if [ -f "$ZRAM_PATCH" ]; then
          if [ -f "$ZRAM_PATCH" ]; then
          echo "Applying LZ4KD patch: $ZRAM_PATCH"
          echo "Applying LZ4KD patch: $ZRAM_PATCH"
          cp "$ZRAM_PATCH" ./
          cp "$ZRAM_PATCH" ./
          if git apply --index --check lz4kd.patch 2>&1 | tee zram_git_check.log; then
          if git apply --index --check lz4kd.patch 2>&1 | tee zram_git_check.log; then
          git apply --index lz4kd.patch
          git apply --index lz4kd.patch
          else
          else
          echo "git apply check failed; trying patch -p auto-detect..."
          echo "git apply check failed; trying patch -p auto-detect..."
          APPLIED=0
          APPLIED=0
          for P in 0 1 2 3; do
          for P in 0 1 2 3; do
          if patch --dry-run -p$P < lz4kd.patch > zram_patch_test_p${P}.log 2>&1; then
          if patch --dry-run -p$P < lz4kd.patch > zram_patch_test_p${P}.log 2>&1; then
          patch -p$P < lz4kd.patch
          patch -p$P < lz4kd.patch
          APPLIED=1
          APPLIED=1
          break
          break
          fi
          fi
          done
          done
          if [ $APPLIED -eq 0 ]; then
          if [ $APPLIED -eq 0 ]; then
          echo "‚ùå Failed to apply LZ4KD patch. Diagnostics:"
          echo "‚ùå Failed to apply LZ4KD patch. Diagnostics:"
          sed -n '1,200p' zram_git_check.log || true
          sed -n '1,200p' zram_git_check.log || true
          for f in zram_patch_test_*.log; do sed -n '1,200p' "$f" || true; done
          for f in zram_patch_test_*.log; do sed -n '1,200p' "$f" || true; done
          # restore backups
          # restore backups
          for backup in ../*_backup_*.tar.gz; do
          for backup in ../*_backup_*.tar.gz; do
          if [ -f "$backup" ]; then tar xzf "$backup"; fi
          if [ -f "$backup" ]; then tar xzf "$backup"; fi
          done
          done
          exit 1
          exit 1
          fi
          fi
          fi
          fi
          else
          else
          echo "‚ö†Ô∏è LZ4KD patch not found for kernel version ${{ github.event.inputs.KERNEL_VERSION }}; skipping"
          echo "‚ö†Ô∏è LZ4KD patch not found for kernel version ${{ github.event.inputs.KERNEL_VERSION }}; skipping"
          fi
          fi


          echo "‚úÖ ZRAM enhancements applied successfully"
          echo "‚úÖ ZRAM enhancements applied successfully"
          
          
      - name: Configure kernel
      - name: Configure kernel
        run: |
        run: |
          cd $BUILD_DIR/source
          cd $BUILD_DIR/source
          echo "üîß Configuring kernel build environment..."
          echo "üîß Configuring kernel build environment..."
          
          
          # Create arch/x86/configs directory if it doesn't exist
          # Create arch/x86/configs directory if it doesn't exist
          mkdir -p arch/x86/configs
          mkdir -p arch/x86/configs
          
          
          # Set up ccache for faster builds
          # Set up ccache for faster builds
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"
          mkdir -p "${CCACHE_DIR}"
          mkdir -p "${CCACHE_DIR}"
          echo "max_size = 5G" > "${CCACHE_DIR}/ccache.conf"
          echo "max_size = 5G" > "${CCACHE_DIR}/ccache.conf"
          
          
          # Create advanced compiler wrapper script
          # Create advanced compiler wrapper script
          echo "üìù Creating compiler wrapper..."
          echo "üìù Creating compiler wrapper..."
          cat > compiler-wrapper.sh << 'EOL'
          cat > compiler-wrapper.sh << 'EOL'
          #!/bin/bash
          #!/bin/bash
          
          
          # Required compiler versions
          # Required compiler versions
          REQUIRED_GCC_VERSION="13.2.0"
          REQUIRED_GCC_VERSION="13.2.0"
          REQUIRED_CLANG_VERSION="17.0.0"
          REQUIRED_CLANG_VERSION="17.0.0"
          MIN_GCC_VERSION="11.0.0"
          MIN_GCC_VERSION="11.0.0"
          MIN_CLANG_VERSION="16.0.0"
          MIN_CLANG_VERSION="16.0.0"
          
          
          # Function to compare version numbers
          # Function to compare version numbers
          version_compare() {
          version_compare() {
          if [[ "$1" == "$2" ]]; then
          if [[ "$1" == "$2" ]]; then
          echo "equal"
          echo "equal"
          return
          return
          fi
          fi
          local IFS=.
          local IFS=.
          local i ver1=($1) ver2=($2)
          local i ver1=($1) ver2=($2)
          for ((i=0; i<${#ver1[@]} || i<${#ver2[@]}; i++)); do
          for ((i=0; i<${#ver1[@]} || i<${#ver2[@]}; i++)); do
          if ((10#${ver1[i]:-0} > 10#${ver2[i]:-0})); then
          if ((10#${ver1[i]:-0} > 10#${ver2[i]:-0})); then
          echo "greater"
          echo "greater"
          return
          return
          elif ((10#${ver1[i]:-0} < 10#${ver2[i]:-0})); then
          elif ((10#${ver1[i]:-0} < 10#${ver2[i]:-0})); then
          echo "less"
          echo "less"
          return
          return
          fi
          fi
          done
          done
          }
          }
          
          
          # Function to detect and validate compiler
          # Function to detect and validate compiler
          detect_compiler() {
          detect_compiler() {
          local compiler_type="unknown"
          local compiler_type="unknown"
          local version=""
          local version=""
              
              
          # Check for GCC
          # Check for GCC
          if command -v gcc >/dev/null 2>&1; then
          if command -v gcc >/dev/null 2>&1; then
          version=$(gcc -dumpversion)
          version=$(gcc -dumpversion)
          compiler_type="gcc"
          compiler_type="gcc"
          if [[ $(version_compare "$version" "$MIN_GCC_VERSION") == "less" ]]; then
          if [[ $(version_compare "$version" "$MIN_GCC_VERSION") == "less" ]]; then
          echo "‚ùå Error: GCC version $version is too old. Minimum required: $MIN_GCC_VERSION" >&2
          echo "‚ùå Error: GCC version $version is too old. Minimum required: $MIN_GCC_VERSION" >&2
          exit 1
          exit 1
          fi
          fi
          if [[ $(version_compare "$version" "$REQUIRED_GCC_VERSION") != "equal" ]]; then
          if [[ $(version_compare "$version" "$REQUIRED_GCC_VERSION") != "equal" ]]; then
          echo "‚ö†Ô∏è Warning: Using GCC $version instead of recommended $REQUIRED_GCC_VERSION" >&2
          echo "‚ö†Ô∏è Warning: Using GCC $version instead of recommended $REQUIRED_GCC_VERSION" >&2
          fi
          fi
          fi
          fi
              
              
          # Check for Clang
          # Check for Clang
          if command -v clang >/dev/null 2>&1; then
          if command -v clang >/dev/null 2>&1; then
          local clang_version=$(clang --version | grep -oP "version \K[0-9]+\.[0-9]+\.[0-9]+")
          local clang_version=$(clang --version | grep -oP "version \K[0-9]+\.[0-9]+\.[0-9]+")
          if [[ -n "$clang_version" ]]; then
          if [[ -n "$clang_version" ]]; then
          if [[ "$compiler_type" == "unknown" ]] ||
          if [[ "$compiler_type" == "unknown" ]] ||
          [[ $(version_compare "$clang_version" "$MIN_CLANG_VERSION") != "less" ]]; then
          [[ $(version_compare "$clang_version" "$MIN_CLANG_VERSION") != "less" ]]; then
          version=$clang_version
          version=$clang_version
          compiler_type="clang"
          compiler_type="clang"
          if [[ $(version_compare "$version" "$REQUIRED_CLANG_VERSION") != "equal" ]]; then
          if [[ $(version_compare "$version" "$REQUIRED_CLANG_VERSION") != "equal" ]]; then
          echo "‚ö†Ô∏è Warning: Using Clang $version instead of recommended $REQUIRED_CLANG_VERSION" >&2
          echo "‚ö†Ô∏è Warning: Using Clang $version instead of recommended $REQUIRED_CLANG_VERSION" >&2
          fi
          fi
          fi
          fi
          fi
          fi
          fi
          fi
              
              
          if [[ "$compiler_type" == "unknown" ]]; then
          if [[ "$compiler_type" == "unknown" ]]; then
          echo "‚ùå Error: No suitable compiler found. Please install GCC $REQUIRED_GCC_VERSION or Clang $REQUIRED_CLANG_VERSION" >&2
          echo "‚ùå Error: No suitable compiler found. Please install GCC $REQUIRED_GCC_VERSION or Clang $REQUIRED_CLANG_VERSION" >&2
          exit 1
          exit 1
          fi
          fi
              
              
          echo "$compiler_type:$version"
          echo "$compiler_type:$version"
          }
          }
          
          
          # Default compiler flags for warning suppression
          # Default compiler flags for warning suppression
          SUPPRESS_WARNINGS=(
          SUPPRESS_WARNINGS=(
              -Wno-error=cast-function-type
              -Wno-error=cast-function-type
              -Wno-error=format-truncation
              -Wno-error=format-truncation
              -Wno-error=format
              -Wno-error=format
              -Wno-error=missing-prototypes
              -Wno-error=missing-prototypes
              -Wno-error=unused-but-set-variable
              -Wno-error=unused-but-set-variable
              -Wno-error=unused-const-variable
              -Wno-error=unused-const-variable
          )
          )
          
          
          # ChromeOS ARCVM specific flags
          # ChromeOS ARCVM specific flags
          ARCVM_FLAGS=(
          ARCVM_FLAGS=(
              -mindirect-branch=thunk-extern
              -mindirect-branch=thunk-extern
              -mindirect-branch-register
              -mindirect-branch-register
              -fno-jump-tables
              -fno-jump-tables
              -fno-delete-null-pointer-checks
              -fno-delete-null-pointer-checks
          )
          )
          
          
          # Detect and validate compiler
          # Detect and validate compiler
          COMPILER_INFO=$(detect_compiler)
          COMPILER_INFO=$(detect_compiler)
          COMPILER_TYPE=${COMPILER_INFO%%:*}
          COMPILER_TYPE=${COMPILER_INFO%%:*}
          COMPILER_VERSION=${COMPILER_INFO#*:}
          COMPILER_VERSION=${COMPILER_INFO#*:}
          
          
          # Set up compiler command
          # Set up compiler command
          if command -v ccache >/dev/null 2>&1; then
          if command -v ccache >/dev/null 2>&1; then
          COMPILER="ccache"
          COMPILER="ccache"
          else
          else
          COMPILER=""
          COMPILER=""
          fi
          fi
          
          
          case $COMPILER_TYPE in
          case $COMPILER_TYPE in
          "gcc")
          "gcc")
          COMPILER="$COMPILER gcc"
          COMPILER="$COMPILER gcc"
          # GCC specific flags
          # GCC specific flags
          EXTRA_FLAGS=(
          EXTRA_FLAGS=(
                      -fno-strict-aliasing
                      -fno-strict-aliasing
                      -fno-common
                      -fno-common
          )
          )
          ;;
          ;;
          "clang")
          "clang")
          COMPILER="$COMPILER clang"
          COMPILER="$COMPILER clang"
          # Clang specific flags
          # Clang specific flags
          EXTRA_FLAGS=(
          EXTRA_FLAGS=(
                      -Wno-error=unused-command-line-argument
                      -Wno-error=unused-command-line-argument
                      -Wno-error=implicit-function-declaration
                      -Wno-error=implicit-function-declaration
          )
          )
          ;;
          ;;
          esac
          esac
          
          
          # Log compiler configuration
          # Log compiler configuration
          echo "üîß Using compiler: $COMPILER_TYPE $COMPILER_VERSION" >&2
          echo "üîß Using compiler: $COMPILER_TYPE $COMPILER_VERSION" >&2
          echo "üìç Compiler path: $(which ${COMPILER##* })" >&2
          echo "üìç Compiler path: $(which ${COMPILER##* })" >&2
          
          
          # Execute compiler with all flags
          # Execute compiler with all flags
          exec $COMPILER "${SUPPRESS_WARNINGS[@]}" "${ARCVM_FLAGS[@]}" "${EXTRA_FLAGS[@]}" "$@"
          exec $COMPILER "${SUPPRESS_WARNINGS[@]}" "${ARCVM_FLAGS[@]}" "${EXTRA_FLAGS[@]}" "$@"
          EOL
          EOL
          chmod +x compiler-wrapper.sh
          chmod +x compiler-wrapper.sh
          
          
          # Verify wrapper script
          # Verify wrapper script
          echo "üîç Verifying compiler wrapper..."
          echo "üîç Verifying compiler wrapper..."
          if ! ./compiler-wrapper.sh -v >/dev/null 2>&1; then
          if ! ./compiler-wrapper.sh -v >/dev/null 2>&1; then
          echo "‚ùå Compiler wrapper verification failed!"
          echo "‚ùå Compiler wrapper verification failed!"
          exit 1
          exit 1
          fi
          fi
          echo "‚úÖ Compiler wrapper created and verified"
          echo "‚úÖ Compiler wrapper created and verified"
          
          
          # Configure environment variables
          # Configure environment variables
          export PATH="$PWD:$PATH"
          export PATH="$PWD:$PATH"
          export KBUILD_BUILD_USER="KaliRootSuperUser"
          export KBUILD_BUILD_USER="KaliRootSuperUser"
          export KBUILD_BUILD_HOST="github-runner"
          export KBUILD_BUILD_HOST="github-runner"
          export KBUILD_BUILD_VERSION="1"
          export KBUILD_BUILD_VERSION="1"
          export KBUILD_BUILD_TIMESTAMP="$(date -u)
          export KBUILD_BUILD_TIMESTAMP="$(date -u)
          
          
          # Set compiler wrapper
          # Set compiler wrapper
          export HOSTCC="./compiler-wrapper.sh"
          export HOSTCC="./compiler-wrapper.sh"
          export CC="./compiler-wrapper.sh"
          export CC="./compiler-wrapper.sh"
          
          
          # Create custom config
          # Create custom config
          cat > arch/x86/configs/chromiumos-x86_64_defconfig << 'EOL'
          cat > arch/x86/configs/chromiumos-x86_64_defconfig << 'EOL'
          CONFIG_X86_64=y
          CONFIG_X86_64=y
          CONFIG_64BIT=y
          CONFIG_64BIT=y
          CONFIG_SMP=y
          CONFIG_SMP=y
          CONFIG_MODULES=y
          CONFIG_MODULES=y
          CONFIG_MODULE_UNLOAD=y
          CONFIG_MODULE_UNLOAD=y
          CONFIG_MODVERSIONS=y
          CONFIG_MODVERSIONS=y
          CONFIG_PARTITION_ADVANCED=y
          CONFIG_PARTITION_ADVANCED=y
          CONFIG_EFI=y
          CONFIG_EFI=y
          CONFIG_EFI_STUB=y
          CONFIG_EFI_STUB=y
          CONFIG_FB=y
          CONFIG_FB=y
          CONFIG_FRAMEBUFFER_CONSOLE=y
          CONFIG_FRAMEBUFFER_CONSOLE=y
          CONFIG_MAGIC_SYSRQ=y
          CONFIG_MAGIC_SYSRQ=y
          CONFIG_MAGIC_SYSRQ_DEFAULT_ENABLE=0x1
          CONFIG_MAGIC_SYSRQ_DEFAULT_ENABLE=0x1
          CONFIG_MAGIC_SYSRQ_SERIAL=y
          CONFIG_MAGIC_SYSRQ_SERIAL=y
          CONFIG_EARLY_PRINTK=y
          CONFIG_EARLY_PRINTK=y
          CONFIG_RANDOMIZE_BASE=y
          CONFIG_RANDOMIZE_BASE=y
          CONFIG_ZBOOT_ROM_TEXT=0x0
          CONFIG_ZBOOT_ROM_TEXT=0x0
          CONFIG_ZBOOT_ROM_BSS=0x0
          CONFIG_ZBOOT_ROM_BSS=0x0
          CONFIG_PROC_KCORE=y
          CONFIG_PROC_KCORE=y
          CONFIG_BLK_DEV_INITRD=y
          CONFIG_BLK_DEV_INITRD=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_WERROR=n
          CONFIG_WERROR=n
          CONFIG_VDSO=y
          CONFIG_VDSO=y
          CONFIG_GENERIC_TIME_VSYSCALL=y
          CONFIG_GENERIC_TIME_VSYSCALL=y
          CONFIG_COMPAT_VDSO=y
          CONFIG_COMPAT_VDSO=y
          CONFIG_SYSVIPC=y
          CONFIG_SYSVIPC=y
          CONFIG_POSIX_MQUEUE=y
          CONFIG_POSIX_MQUEUE=y
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_MEMCG=y
          CONFIG_MEMCG=y
          CONFIG_BLK_CGROUP=y
          CONFIG_BLK_CGROUP=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_NAMESPACES=y
          CONFIG_NAMESPACES=y
          CONFIG_SECURITY=y
          CONFIG_SECURITY=y
          CONFIG_SECURITY_NETWORK=y
          CONFIG_SECURITY_NETWORK=y
          CONFIG_HARDENED_USERCOPY=y
          CONFIG_HARDENED_USERCOPY=y
          CONFIG_STACKPROTECTOR_STRONG=y
          CONFIG_STACKPROTECTOR_STRONG=y
          CONFIG_MODULES_TREE_LOOKUP=y
          CONFIG_MODULES_TREE_LOOKUP=y
          EOL
          EOL
          
          
          # Verify kernel/sched/rt.c exists and is writable
          # Verify kernel/sched/rt.c exists and is writable
          if [ ! -w "kernel/sched/rt.c" ]; then
          if [ ! -w "kernel/sched/rt.c" ]; then
          echo "‚ö†Ô∏è Warning: kernel/sched/rt.c is not writable or doesn't exist"
          echo "‚ö†Ô∏è Warning: kernel/sched/rt.c is not writable or doesn't exist"
          find . -name "rt.c" -type f
          find . -name "rt.c" -type f
          fi
          fi
          
          
          # Create arch/x86/configs directory if it doesn't exist
          # Create arch/x86/configs directory if it doesn't exist
          mkdir -p arch/x86/configs
          mkdir -p arch/x86/configs
          
          
          # Create base defconfig file
          # Create base defconfig file
          cat > arch/x86/configs/chromiumos-x86_64_defconfig << 'EOL'
          cat > arch/x86/configs/chromiumos-x86_64_defconfig << 'EOL'
          CONFIG_X86_64=y
          CONFIG_X86_64=y
          CONFIG_64BIT=y
          CONFIG_64BIT=y
          CONFIG_SMP=y
          CONFIG_SMP=y
          CONFIG_MODULES=y
          CONFIG_MODULES=y
          CONFIG_MODULE_UNLOAD=y
          CONFIG_MODULE_UNLOAD=y
          CONFIG_MODVERSIONS=y
          CONFIG_MODVERSIONS=y
          CONFIG_PARTITION_ADVANCED=y
          CONFIG_PARTITION_ADVANCED=y
          CONFIG_EFI=y
          CONFIG_EFI=y
          CONFIG_EFI_STUB=y
          CONFIG_EFI_STUB=y
          CONFIG_FB=y
          CONFIG_FB=y
          CONFIG_FRAMEBUFFER_CONSOLE=y
          CONFIG_FRAMEBUFFER_CONSOLE=y
          CONFIG_MAGIC_SYSRQ=y
          CONFIG_MAGIC_SYSRQ=y
          CONFIG_MAGIC_SYSRQ_DEFAULT_ENABLE=0x1
          CONFIG_MAGIC_SYSRQ_DEFAULT_ENABLE=0x1
          CONFIG_MAGIC_SYSRQ_SERIAL=y
          CONFIG_MAGIC_SYSRQ_SERIAL=y
          CONFIG_EARLY_PRINTK=y
          CONFIG_EARLY_PRINTK=y
          CONFIG_RANDOMIZE_BASE=y
          CONFIG_RANDOMIZE_BASE=y
          CONFIG_ZBOOT_ROM_TEXT=0x0
          CONFIG_ZBOOT_ROM_TEXT=0x0
          CONFIG_ZBOOT_ROM_BSS=0x0
          CONFIG_ZBOOT_ROM_BSS=0x0
          CONFIG_PROC_KCORE=y
          CONFIG_PROC_KCORE=y
          CONFIG_BLK_DEV_INITRD=y
          CONFIG_BLK_DEV_INITRD=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_LOCALVERSION="-SukiSU-Ultra"
          CONFIG_LOCALVERSION="-SukiSU-Ultra"
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_SYSVIPC=y
          CONFIG_SYSVIPC=y
          CONFIG_POSIX_MQUEUE=y
          CONFIG_POSIX_MQUEUE=y
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_MEMCG=y
          CONFIG_MEMCG=y
          CONFIG_BLK_CGROUP=y
          CONFIG_BLK_CGROUP=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_NAMESPACES=y
          CONFIG_NAMESPACES=y
          CONFIG_SECURITY=y
          CONFIG_SECURITY=y
          CONFIG_SECURITY_NETWORK=y
          CONFIG_SECURITY_NETWORK=y
          CONFIG_HARDENED_USERCOPY=y
          CONFIG_HARDENED_USERCOPY=y
          CONFIG_STACKPROTECTOR_STRONG=y
          CONFIG_STACKPROTECTOR_STRONG=y
          CONFIG_MODULES_TREE_LOOKUP=y
          CONFIG_MODULES_TREE_LOOKUP=y
          EOL
          EOL
          
          
          # Apply base configuration
          # Apply base configuration
          make ARCH=x86_64 chromiumos-x86_64_defconfig
          make ARCH=x86_64 chromiumos-x86_64_defconfig
          
          
          # Configure additional kernel options
          # Configure additional kernel options
          cat >> .config << 'EOL'
          cat >> .config << 'EOL'
          CONFIG_KSU=y
          CONFIG_KSU=y
          CONFIG_KPM=y
          CONFIG_KPM=y
          CONFIG_LOCALVERSION="-SukiSU-Ultra"
          CONFIG_LOCALVERSION="-SukiSU-Ultra"
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_LOCALVERSION_AUTO=n
          EOL
          EOL
          
          
          # Enable VFS hooks if requested
          # Enable VFS hooks if requested
          if [[ "${{ github.event.inputs.VFS_HOOKS }}" == "true" ]]; then
          if [[ "${{ github.event.inputs.VFS_HOOKS }}" == "true" ]]; then
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> .config
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> .config
          fi
          fi
          
          
          # Update configuration
          # Update configuration
          make ARCH=x86_64 olddefconfig
          make ARCH=x86_64 olddefconfig
          
          
      - name: Build kernel
      - name: Build kernel
        run: |
        run: |
          cd kernel
          cd kernel
          echo "Building kernel with $(nproc) cores..."
          echo "Building kernel with $(nproc) cores..."
          
          
          # Fix function prototype in vgetcpu.c
          # Fix function prototype in vgetcpu.c
          echo 'long __vdso_getcpu(unsigned *cpu, unsigned *node, struct getcpu_cache *unused);' > arch/x86/entry/vdso/vgetcpu.h
          echo 'long __vdso_getcpu(unsigned *cpu, unsigned *node, struct getcpu_cache *unused);' > arch/x86/entry/vdso/vgetcpu.h
          sed -i '1i#include "vgetcpu.h"' arch/x86/entry/vdso/vgetcpu.c
          sed -i '1i#include "vgetcpu.h"' arch/x86/entry/vdso/vgetcpu.c
          
          
          # Fix function cast in sock.h
          # Fix function cast in sock.h
          sed -i 's/android_dst_ops_negative_advice_new_t/void (*)(struct sock *, struct dst_entry *)/' include/net/sock.h
          sed -i 's/android_dst_ops_negative_advice_new_t/void (*)(struct sock *, struct dst_entry *)/' include/net/sock.h
          
          
          # Set additional compiler flags to handle warnings
          # Set additional compiler flags to handle warnings
          export KCFLAGS="-Wno-error=cast-function-type -Wno-error=format-truncation -Wno-error=format -Wno-error=missing-prototypes"
          export KCFLAGS="-Wno-error=cast-function-type -Wno-error=format-truncation -Wno-error=format -Wno-error=missing-prototypes"
          export KCPPFLAGS="-P"
          export KCPPFLAGS="-P"
          
          
          # First try with standard options
          # First try with standard options
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) all W=1 \
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) all W=1 \
          KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS" || \
          KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS" || \
          # If failed, try with additional debug options
          # If failed, try with additional debug options
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) V=1 W=1 \
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) V=1 W=1 \
          KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS"
          KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS"
          
          
          # Build modules and bzImage
          # Build modules and bzImage
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) bzImage modules \
          make ARCH=x86_64 CROSS_COMPILE="" -j$(nproc) bzImage modules \
          KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS"
          KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS"
          
          
          if [ ! -f "arch/x86/boot/bzImage" ]; then
          if [ ! -f "arch/x86/boot/bzImage" ]; then
          echo "‚ùå Kernel build failed - bzImage not found"
          echo "‚ùå Kernel build failed - bzImage not found"
          echo "Dumping last 100 lines of build log..."
          echo "Dumping last 100 lines of build log..."
          tail -n 100 .build.log
          tail -n 100 .build.log
          exit 1
          exit 1
          fi
          fi
          
          
          echo "‚úÖ Kernel build completed successfully"
          echo "‚úÖ Kernel build completed successfully"
          
          
      - name: Package kernel and source tree
      - name: Package kernel and source tree
        run: |
        run: |
          echo "üì¶ Creating kernel packages..."
          echo "üì¶ Creating kernel packages..."
          
          
          # Create compiled kernel package
          # Create compiled kernel package
          echo "Creating compiled kernel package..."
          echo "Creating compiled kernel package..."
          mkdir -p dist/kernel
          mkdir -p dist/kernel
          cp kernel/arch/x86/boot/bzImage dist/kernel/
          cp kernel/arch/x86/boot/bzImage dist/kernel/
          cp kernel/System.map dist/kernel/
          cp kernel/System.map dist/kernel/
          cp -r kernel/include dist/kernel/
          cp -r kernel/include dist/kernel/
          
          
          cd dist
          cd dist
          zip -r ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip kernel/
          zip -r ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip kernel/
          echo "‚úÖ Compiled kernel package prepared"
          echo "‚úÖ Compiled kernel package prepared"
          
          
          # Create source tree package
          # Create source tree package
          echo "Creating source tree package..."
          echo "Creating source tree package..."
          cd ..
          cd ..
          echo "Preparing source tree for packaging..."
          echo "Preparing source tree for packaging..."
          
          
          # Clean build artifacts before packaging source
          # Clean build artifacts before packaging source
          cd kernel
          cd kernel
          make clean
          make clean
          
          
          # Create source package directory
          # Create source package directory
          cd ..
          cd ..
          mkdir -p dist/source_tree
          mkdir -p dist/source_tree
          
          
          # Copy the complete modified kernel source
          # Copy the complete modified kernel source
          cp -r kernel/* dist/source_tree/
          cp -r kernel/* dist/source_tree/
          
          
          # Create source tree archive
          # Create source tree archive
          cd dist
          cd dist
          tar -czf ARCVM-x86_64-SUKISU-ULTRA-SUSFS-ROOTED-KERNEL-SOURCE.tar.gz source_tree/
          tar -czf ARCVM-x86_64-SUKISU-ULTRA-SUSFS-ROOTED-KERNEL-SOURCE.tar.gz source_tree/
          echo "‚úÖ Source tree package prepared"
          echo "‚úÖ Source tree package prepared"
          
          
      - name: Upload compiled kernel package
      - name: Upload compiled kernel package
        uses: actions/upload-artifact@v4
        uses: actions/upload-artifact@v4
        with:
        with:
          name: compiled-kernel
          name: compiled-kernel
          path: dist/ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip
          path: dist/ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip
          compression-level: 9
          compression-level: 9
          retention-days: 90
          retention-days: 90
          
          
      - name: Upload source tree package
      - name: Upload source tree package
        uses: actions/upload-artifact@v4
        uses: actions/upload-artifact@v4
        with:
        with:
          name: kernel-source-tree
          name: kernel-source-tree
          path: dist/ARCVM-x86_64-SUKISU-ULTRA-SUSFS-ROOTED-KERNEL-SOURCE.tar.gz
          path: dist/ARCVM-x86_64-SUKISU-ULTRA-SUSFS-ROOTED-KERNEL-SOURCE.tar.gz
          compression-level: 9
          compression-level: 9
          retention-days: 90
          retention-days: 90

