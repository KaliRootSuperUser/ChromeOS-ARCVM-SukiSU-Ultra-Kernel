name: Build ChromeOS ARCVM Kernel with SukiSU Ultra + SUSFS
name: Build ChromeOS ARCVM Kernel with SukiSU Ultra + SUSFS


on:
on:
  workflow_dispatch:
  workflow_dispatch:
    inputs:
    inputs:
      KERNEL_BRANCH:
      KERNEL_BRANCH:
        description: 'Select kernel branch'
        description: 'Select kernel branch'
        required: true
        required: true
        default: 'chromeos-5.10-arcvm'
        default: 'chromeos-5.10-arcvm'
        type: choice
        type: choice
        options:
        options:
          - 'chromeos-5.10-arcvm'
          - 'chromeos-5.10-arcvm'
          - 'chromeos-5.15-arcvm'
          - 'chromeos-5.15-arcvm'
      
      
      ANDROID_VERSION:
      ANDROID_VERSION:
        description: 'Select Android version'
        description: 'Select Android version'
        required: true
        required: true
        default: 'android13'
        default: 'android13'
        type: choice
        type: choice
        options:
        options:
          - 'android12'
          - 'android12'
          - 'android13'
          - 'android13'
          - 'android14'
          - 'android14'
          - 'android15'
          - 'android15'
      
      
      KERNEL_VERSION:
      KERNEL_VERSION:
        description: 'Select kernel version'
        description: 'Select kernel version'
        required: true
        required: true
        default: '5.10'
        default: '5.10'
        type: choice
        type: choice
        options:
        options:
          - '5.10'
          - '5.10'
          - '5.15'
          - '5.15'
          - '6.1'
          - '6.1'
          - '6.6'
          - '6.6'
      
      
      VFS_HOOKS:
      VFS_HOOKS:
        description: 'Enable VFS manual hooks'
        description: 'Enable VFS manual hooks'
        required: false
        required: false
        type: boolean
        type: boolean
        default: true
        default: true
      
      
      KPM:
      KPM:
        description: 'Enable KPM (Kernel Patch Module)'
        description: 'Enable KPM (Kernel Patch Module)'
        required: false
        required: false
        type: boolean
        type: boolean
        default: true
        default: true
      
      
      ZRAM:
      ZRAM:
        description: 'Enable ZRAM enhancement'
        description: 'Enable ZRAM enhancement'
        required: false
        required: false
        type: boolean
        type: boolean
        default: true
        default: true


jobs:
jobs:
  build-kernel:
  build-kernel:
    runs-on: ubuntu-latest
    runs-on: ubuntu-latest
    
    
    steps:
    steps:
      - name: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        uses: actions/checkout@v3
        with:
        with:
          fetch-depth: 1
          fetch-depth: 1
          
          
      - name: Setup build environment
      - name: Setup build environment
        run: |
        run: |
          sudo apt-get update
          sudo apt-get update
          sudo apt-get install -y build-essential python3 git curl bc bison flex libssl-dev libelf-dev ccache
          sudo apt-get install -y build-essential python3 git curl bc bison flex libssl-dev libelf-dev ccache
          
          
      - name: Configure Git
      - name: Configure Git
        run: |
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global user.email "actions@github.com"
          
          
      - name: Clone kernel source
      - name: Clone kernel source
        run: |
        run: |
          git clone --depth=1 -b ${{ github.event.inputs.KERNEL_BRANCH }} https://chromium.googlesource.com/chromiumos/third_party/kernel
          git clone --depth=1 -b ${{ github.event.inputs.KERNEL_BRANCH }} https://chromium.googlesource.com/chromiumos/third_party/kernel
          cd kernel
          cd kernel
          
          
      - name: Apply patches
      - name: Apply patches
        run: |
        run: |
          echo "Applying SukiSU Ultra patches..."
          echo "Applying SukiSU Ultra patches..."
          git apply --ignore-whitespace ../patches/50_add_sukisu_ultra.patch
          git apply --ignore-whitespace ../patches/50_add_sukisu_ultra.patch
          
          
          echo "Applying SUSFS patches..."
          echo "Applying SUSFS patches..."
          git apply --ignore-whitespace ../patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch
          git apply --ignore-whitespace ../patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch
          
          
          if [[ "${{ github.event.inputs.VFS_HOOKS }}" == "true" ]]; then
          if [[ "${{ github.event.inputs.VFS_HOOKS }}" == "true" ]]; then
          echo "Enabling VFS hooks..."
          echo "Enabling VFS hooks..."
          git apply --ignore-whitespace ../patches/51_enable_vfs_hooks.patch
          git apply --ignore-whitespace ../patches/51_enable_vfs_hooks.patch
          fi
          fi
          
          
          if [[ "${{ github.event.inputs.KPM }}" == "true" ]]; then
          if [[ "${{ github.event.inputs.KPM }}" == "true" ]]; then
          echo "Enabling KPM support..."
          echo "Enabling KPM support..."
          git apply --ignore-whitespace ../patches/52_enable_kpm.patch
          git apply --ignore-whitespace ../patches/52_enable_kpm.patch
          fi
          fi
          
          
          if [[ "${{ github.event.inputs.ZRAM }}" == "true" ]]; then
          if [[ "${{ github.event.inputs.ZRAM }}" == "true" ]]; then
          echo "Enabling ZRAM enhancement..."
          echo "Enabling ZRAM enhancement..."
          git apply --ignore-whitespace ../patches/53_enable_zram_enhancement.patch
          git apply --ignore-whitespace ../patches/53_enable_zram_enhancement.patch
          fi
          fi
          
          
      - name: Configure kernel
      - name: Configure kernel
        run: |
        run: |
          cd kernel
          cd kernel
          make ARCH=x86_64 chromiumos-x86_64_defconfig
          make ARCH=x86_64 chromiumos-x86_64_defconfig
          scripts/config --enable CONFIG_KSU
          scripts/config --enable CONFIG_KSU
          scripts/config --enable CONFIG_KPM
          scripts/config --enable CONFIG_KPM
          
          
          if [[ "${{ github.event.inputs.VFS_HOOKS }}" == "true" ]]; then
          if [[ "${{ github.event.inputs.VFS_HOOKS }}" == "true" ]]; then
          scripts/config --enable CONFIG_KSU_MANUAL_HOOK
          scripts/config --enable CONFIG_KSU_MANUAL_HOOK
          fi
          fi
          
          
      - name: Build kernel
      - name: Build kernel
        run: |
        run: |
          cd kernel
          cd kernel
          make ARCH=x86_64 -j$(nproc) bzImage modules
          make ARCH=x86_64 -j$(nproc) bzImage modules
          
          
      - name: Package kernel
      - name: Package kernel
        run: |
        run: |
          echo "Creating kernel package..."
          echo "Creating kernel package..."
          mkdir -p dist/kernel
          mkdir -p dist/kernel
          cp kernel/arch/x86/boot/bzImage dist/kernel/
          cp kernel/arch/x86/boot/bzImage dist/kernel/
          cp kernel/System.map dist/kernel/
          cp kernel/System.map dist/kernel/
          cp -r kernel/include dist/kernel/
          cp -r kernel/include dist/kernel/
          
          
          cd dist
          cd dist
          zip -r ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip kernel/
          zip -r ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip kernel/
          echo "✅ Kernel package prepared"
          echo "✅ Kernel package prepared"
          
          
      - name: Upload kernel package
      - name: Upload kernel package
        uses: actions/upload-artifact@v4
        uses: actions/upload-artifact@v4
        with:
        with:
          name: kernel-package
          name: kernel-package
          path: dist/ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip
          path: dist/ChromeOS-ARCVM-x86_64-SukiSU-Ultra-Kernel.zip
          compression-level: 9
          compression-level: 9
          retention-days: 90
          retention-days: 90

